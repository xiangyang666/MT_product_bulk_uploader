# ç”Ÿæˆæ¨¡æ¿500é”™è¯¯ - å·²ä¿®å¤ âœ…

## ğŸ› é—®é¢˜æè¿°

ç‚¹å‡»"ç”Ÿæˆæ¨¡æ¿"æŒ‰é’®æ—¶æŠ¥é”™ï¼š
```
POST http://localhost:5173/api/products/generate-template 500 (Internal Server Error)
AxiosError: Request failed with status code 500
```

---

## ğŸ” æ ¹æœ¬åŸå› 

**é—®é¢˜å‡ºåœ¨å‰ç«¯çš„axioså“åº”æ‹¦æˆªå™¨ï¼**

### è¯¦ç»†è¯´æ˜ï¼š

1. **ç”Ÿæˆæ¨¡æ¿APIè¿”å›çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆExcelï¼‰**ï¼Œä¸æ˜¯JSON
   - åç«¯è¿”å›ï¼š`byte[]` (Excelæ–‡ä»¶çš„å­—èŠ‚æ•°ç»„)
   - Content-Type: `application/octet-stream`

2. **å‰ç«¯ä½¿ç”¨äº† `responseType: 'blob'` æ¥æ¥æ”¶æ–‡ä»¶**
   ```javascript
   const response = await request.post('/products/generate-template', {
     productIds: productIds
   }, {
     responseType: 'blob'  // å‘Šè¯‰axiosè¿™æ˜¯äºŒè¿›åˆ¶æ•°æ®
   })
   ```

3. **ä½†æ˜¯axioså“åº”æ‹¦æˆªå™¨è¯•å›¾å°†blobå½“ä½œJSONè§£æ**
   ```javascript
   // åŸæ¥çš„ä»£ç ï¼ˆæœ‰é—®é¢˜ï¼‰
   response => {
     const res = response.data  // è¿™é‡Œdataæ˜¯blobï¼Œä¸æ˜¯JSON
     
     if (res.code !== 200) {    // blobæ²¡æœ‰codeå±æ€§ï¼
       ElMessage.error(res.message || 'è¯·æ±‚å¤±è´¥')
       return Promise.reject(new Error(res.message || 'è¯·æ±‚å¤±è´¥'))
     }
     
     return res
   }
   ```

4. **ç»“æœï¼šæ‹¦æˆªå™¨å°è¯•è®¿é—® `blob.code`ï¼Œå¯¼è‡´é”™è¯¯**

---

## âœ… è§£å†³æ–¹æ¡ˆ

**ä¿®æ”¹ `meituan-frontend/src/api/index.js` çš„å“åº”æ‹¦æˆªå™¨ï¼š**

### ä¿®æ”¹å‰ï¼š
```javascript
request.interceptors.response.use(
  response => {
    const res = response.data
    
    // æ ¹æ®ä¸šåŠ¡çŠ¶æ€ç å¤„ç†
    if (res.code !== 200) {
      ElMessage.error(res.message || 'è¯·æ±‚å¤±è´¥')
      return Promise.reject(new Error(res.message || 'è¯·æ±‚å¤±è´¥'))
    }
    
    return res
  },
  // ...
)
```

### ä¿®æ”¹åï¼š
```javascript
request.interceptors.response.use(
  response => {
    // å¦‚æœæ˜¯blobç±»å‹ï¼ˆæ–‡ä»¶ä¸‹è½½ï¼‰ï¼Œç›´æ¥è¿”å›data
    if (response.config.responseType === 'blob') {
      return response.data
    }
    
    const res = response.data
    
    // æ ¹æ®ä¸šåŠ¡çŠ¶æ€ç å¤„ç†
    if (res.code !== 200) {
      ElMessage.error(res.message || 'è¯·æ±‚å¤±è´¥')
      return Promise.reject(new Error(res.message || 'è¯·æ±‚å¤±è´¥'))
    }
    
    return res
  },
  // ...
)
```

### å…³é”®æ”¹åŠ¨ï¼š
```javascript
// æ–°å¢è¿™ä¸ªåˆ¤æ–­
if (response.config.responseType === 'blob') {
  return response.data  // ç›´æ¥è¿”å›blobæ•°æ®ï¼Œä¸åšJSONè§£æ
}
```

---

## ğŸ¯ æµ‹è¯•æ­¥éª¤

### 1. åˆ·æ–°å‰ç«¯é¡µé¢
æŒ‰ `F5` åˆ·æ–°æµè§ˆå™¨

### 2. è¿›å…¥æ‰¹é‡ä¸Šä¼ é¡µé¢
ç‚¹å‡»å·¦ä¾§èœå• â†’ æ‰¹é‡ä¸Šä¼ 

### 3. é€‰æ‹©å•†å“
å‹¾é€‰è¦ç”Ÿæˆæ¨¡æ¿çš„å•†å“

### 4. ç‚¹å‡»"ç”Ÿæˆæ¨¡æ¿"
ç‚¹å‡»é»„è‰²çš„"ç”Ÿæˆæ¨¡æ¿"æŒ‰é’®

### 5. éªŒè¯ç»“æœ
âœ… æ–‡ä»¶åº”è¯¥è‡ªåŠ¨ä¸‹è½½
âœ… æ–‡ä»¶åæ ¼å¼ï¼š`meituan_template_20260209123456.xlsx`
âœ… å¯ä»¥ç”¨Excelæ‰“å¼€æŸ¥çœ‹å†…å®¹

---

## ğŸ“‹ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

1. **åç«¯APIè®¾è®¡**
   - ç”Ÿæˆæ¨¡æ¿APIè¿”å›çš„æ˜¯æ–‡ä»¶ï¼Œä¸æ˜¯JSON
   - ä½¿ç”¨ `ResponseEntity<byte[]>` è¿”å›Excelæ–‡ä»¶
   - Content-Type: `application/octet-stream`

2. **å‰ç«¯è¯·æ±‚é…ç½®**
   - ä½¿ç”¨ `responseType: 'blob'` å‘Šè¯‰axiosè¿™æ˜¯äºŒè¿›åˆ¶æ•°æ®
   - axiosä¼šå°†å“åº”æ•°æ®ä½œä¸ºBlobå¯¹è±¡å¤„ç†

3. **æ‹¦æˆªå™¨å†²çª**
   - åŸæ¥çš„æ‹¦æˆªå™¨å‡è®¾æ‰€æœ‰å“åº”éƒ½æ˜¯JSON
   - å°è¯•è®¿é—® `response.data.code`
   - ä½†blobå¯¹è±¡æ²¡æœ‰codeå±æ€§ï¼Œå¯¼è‡´é”™è¯¯

### æ­£ç¡®çš„å¤„ç†æ–¹å¼

**å¯¹äºä¸åŒç±»å‹çš„å“åº”ï¼Œéœ€è¦ä¸åŒçš„å¤„ç†ï¼š**

```javascript
// JSONå“åº”ï¼ˆå¤§éƒ¨åˆ†APIï¼‰
{
  code: 200,
  message: "æˆåŠŸ",
  data: { ... }
}
â†’ æ£€æŸ¥codeï¼Œè¿”å›data

// Blobå“åº”ï¼ˆæ–‡ä»¶ä¸‹è½½ï¼‰
Blob { size: 12345, type: "application/..." }
â†’ ç›´æ¥è¿”å›blobï¼Œä¸åšJSONè§£æ
```

---

## ğŸ”§ ç›¸å…³æ–‡ä»¶

### å·²ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- âœ… `meituan-frontend/src/api/index.js` - ä¿®å¤å“åº”æ‹¦æˆªå™¨

### ç›¸å…³æ–‡ä»¶ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰ï¼š
- `meituan-frontend/src/views/Upload.vue` - æ‰¹é‡ä¸Šä¼ é¡µé¢
- `meituan-backend/src/main/java/com/meituan/product/controller/ProductController.java` - åç«¯æ§åˆ¶å™¨
- `meituan-backend/src/main/java/com/meituan/product/service/ExcelService.java` - Excelç”ŸæˆæœåŠ¡

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### 1. æ–‡ä»¶ä¸‹è½½APIçš„æ­£ç¡®å¤„ç†æ–¹å¼

**åç«¯ï¼š**
```java
@PostMapping("/generate-template")
public ResponseEntity<byte[]> generateTemplate(@RequestBody GenerateTemplateRequest request) {
    byte[] excelData = productService.generateMeituanTemplate(request.getProductIds());
    
    HttpHeaders headers = new HttpHeaders();
    headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);
    headers.setContentDispositionFormData("attachment", fileName);
    
    return ResponseEntity.ok()
            .headers(headers)
            .body(excelData);
}
```

**å‰ç«¯ï¼š**
```javascript
// 1. è¯·æ±‚æ—¶æŒ‡å®šresponseType
const response = await request.post('/api/endpoint', data, {
  responseType: 'blob'
})

// 2. æ‹¦æˆªå™¨ä¸­ç‰¹æ®Šå¤„ç†
if (response.config.responseType === 'blob') {
  return response.data  // ç›´æ¥è¿”å›blob
}

// 3. åˆ›å»ºä¸‹è½½é“¾æ¥
const blob = new Blob([response], { type: 'application/...' })
const url = window.URL.createObjectURL(blob)
const link = document.createElement('a')
link.href = url
link.download = 'filename.xlsx'
link.click()
```

### 2. axiosæ‹¦æˆªå™¨çš„æœ€ä½³å®è·µ

```javascript
// å“åº”æ‹¦æˆªå™¨åº”è¯¥å¤„ç†ä¸åŒç±»å‹çš„å“åº”
request.interceptors.response.use(
  response => {
    // æ–‡ä»¶ä¸‹è½½
    if (response.config.responseType === 'blob') {
      return response.data
    }
    
    // JSONå“åº”
    const res = response.data
    if (res.code !== 200) {
      // é”™è¯¯å¤„ç†
    }
    return res
  },
  error => {
    // é”™è¯¯å¤„ç†
  }
)
```

### 3. è°ƒè¯•æŠ€å·§

**å½“é‡åˆ°ç±»ä¼¼é—®é¢˜æ—¶ï¼š**

1. æ‰“å¼€æµè§ˆå™¨F12 â†’ Network
2. æ‰¾åˆ°å¤±è´¥çš„è¯·æ±‚
3. æŸ¥çœ‹ Response Headers ä¸­çš„ Content-Type
4. å¦‚æœæ˜¯ `application/octet-stream` æˆ– `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
5. è¯´æ˜æ˜¯æ–‡ä»¶ä¸‹è½½ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†

---

## âœ… é—®é¢˜å·²è§£å†³

ç°åœ¨"ç”Ÿæˆæ¨¡æ¿"åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼

**æµ‹è¯•æ¸…å•ï¼š**
- [x] ä¿®å¤axioså“åº”æ‹¦æˆªå™¨
- [ ] åˆ·æ–°å‰ç«¯é¡µé¢
- [ ] é€‰æ‹©å•†å“å¹¶ç”Ÿæˆæ¨¡æ¿
- [ ] éªŒè¯æ–‡ä»¶ä¸‹è½½æˆåŠŸ
- [ ] éªŒè¯Excelæ–‡ä»¶å¯ä»¥æ­£å¸¸æ‰“å¼€

---

**ä¿®å¤æ—¥æœŸ**: 2026-02-09  
**ä¿®å¤äººå‘˜**: Kiro AI Assistant  
**é—®é¢˜ç±»å‹**: å‰ç«¯axiosæ‹¦æˆªå™¨é…ç½®é”™è¯¯  
**å½±å“èŒƒå›´**: æ‰¹é‡ä¸Šä¼  - ç”Ÿæˆæ¨¡æ¿åŠŸèƒ½  
**çŠ¶æ€**: âœ… å·²ä¿®å¤
