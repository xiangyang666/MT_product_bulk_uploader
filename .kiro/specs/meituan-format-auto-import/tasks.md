# 实现计划 - 美团格式自动识别导入

## 任务列表

- [x] 1. 创建格式检测和数据模型
  - 创建FormatType枚举类
  - 创建ErrorDetail数据类
  - 扩展ImportResult类，添加格式类型和错误详情字段
  - _需求: 1.1, 3.1, 3.2_

- [x] 2. 实现FormatDetector（格式识别器）
  - 创建FormatDetector类
  - 实现detectFormat方法（检测美团格式的必需列）
  - 实现getMeituanColumnMapping方法（生成列名到索引的映射）
  - _需求: 1.1, 1.3_

- [ ]* 2.1 编写FormatDetector的属性测试
  - **属性 1: 美团格式识别准确性**
  - **验证: 需求 1.1**
  - 生成包含美团必需列的随机表头，验证识别为美团格式
  - 生成不包含美团必需列的随机表头，验证不识别为美团格式

- [x] 3. 实现MeituanFormatParser（美团格式解析器）
  - 创建MeituanFormatParser类
  - 实现parseRow方法（解析单行美团格式数据）
  - 实现extractField方法（从行中提取指定列的值）
  - 实现字段映射逻辑（商品名称、类目ID、价格、库存、描述）
  - _需求: 1.2, 2.7, 2.8_

- [ ]* 3.1 编写MeituanFormatParser的属性测试
  - **属性 2: 字段提取完整性**
  - **验证: 需求 1.2**
  - 生成随机的美团格式数据，验证所有字段正确提取
  - **属性 7: 库存转换默认值正确性**
  - **验证: 需求 2.7**
  - 测试空库存值转换为0
  - **属性 8: 描述截取长度正确性**
  - **验证: 需求 2.8**
  - 测试超长描述截取为1000字符

- [x] 4. 增强DataValidator（数据验证器）
  - 在现有验证逻辑基础上，确保支持美团格式提取的数据
  - 验证类目ID格式（10位数字）
  - 验证价格范围（0 < price <= 99999.99）
  - 验证商品名称（非空且长度<=255）
  - _需求: 2.1, 2.3, 2.5_

- [ ]* 4.1 编写DataValidator的属性测试
  - **属性 4: 类目ID验证一致性**
  - **验证: 需求 2.1, 2.2**
  - 生成各种格式的类目ID，验证10位数字规则
  - **属性 5: 价格验证边界正确性**
  - **验证: 需求 2.3, 2.4**
  - 生成各种价格值，验证范围规则
  - **属性 6: 商品名称验证完整性**
  - **验证: 需求 2.5, 2.6**
  - 生成各种长度的商品名称，验证长度规则

- [x] 5. 修改ExcelService集成格式识别
  - 在parseExcel方法中添加格式检测逻辑
  - 根据检测结果选择使用MeituanFormatParser或现有的标准格式解析
  - 收集验证错误并继续处理其他行（不中断处理）
  - 生成详细的错误报告（行号、字段名、错误原因）
  - _需求: 1.3, 2.2, 2.4, 2.6, 3.1_

- [ ]* 5.1 编写ExcelService的属性测试
  - **属性 3: 格式回退正确性**
  - **验证: 需求 1.3, 5.3**
  - 测试不符合美团格式的文件使用标准格式处理
  - **属性 9: 错误记录完整性**
  - **验证: 需求 3.1**
  - 验证错误记录包含行号、字段名和错误原因
  - **属性 10: 统计信息一致性**
  - **验证: 需求 3.2**
  - 验证总行数 = 成功行数 + 失败行数

- [x] 6. 更新ImportResult返回详细信息
  - 添加formatType字段（MEITUAN / STANDARD）
  - 添加errors列表（包含ErrorDetail对象）
  - 添加hasMoreErrors和remainingErrorCount字段
  - 限制错误详情最多返回100条
  - _需求: 3.2, 3.3, 3.4_

- [ ]* 6.1 编写ImportResult的属性测试
  - **属性 11: 错误详情数量限制**
  - **验证: 需求 3.3, 3.4**
  - 生成超过100条错误的数据，验证只返回前100条

- [x] 7. 更新ProductController的预览接口

  - 在previewProducts方法中返回格式识别信息
  - 添加"已识别为美团格式"的提示信息
  - 限制预览数据为前20行
  - 返回预览统计信息（预计成功X行，Y行存在错误）
  - _需求: 4.1, 4.2, 4.3, 4.5_

- [ ]* 7.1 编写预览接口的属性测试
  - **属性 12: 预览数据结构正确性**
  - **验证: 需求 4.2**
  - 验证美团格式预览返回6个字段
  - **属性 13: 预览数量限制正确性**
  - **验证: 需求 4.3**
  - 验证预览数据不超过20行
  - **属性 14: 预览统计准确性**
  - **验证: 需求 4.5**
  - 验证预计成功行数 + 错误行数 = 总行数


- [x] 8. 更新ProductController的导入接口
  - 在importProducts方法中返回格式识别信息
  - 返回详细的错误报告
  - 添加处理耗时统计
  - _需求: 3.2, 6.4_

- [ ] 9. 添加配置文件支持（可选）
  - 创建MeituanFormatConfig配置类
  - 配置美团格式的必需列列表
  - 配置字段映射关系
  - 配置验证规则（类目ID正则、价格范围、长度限制）
  - _需求: 可维护性_


  - _注：当前硬编码在FormatDetector和MeituanFormatParser中，可后续优化_

- [x] 10. 更新前端Import.vue
  - 在预览结果中显示格式识别信息
  - 显示"已识别为美团格式"提示
  - 优化错误信息展示（显示行号、字段名、错误原因）
  - 显示统计信息（总行数、成功、失败）
  - _需求: 4.1, 4.4_

- [ ] 11. 添加Product实体的dataSource字段
  - 在Product类中添加dataSource字段（MEITUAN / STANDARD）
  - 更新数据库表结构（添加data_source列）
  - 在保存商品时记录数据来源
  - _需求: 数据模型_

- [ ] 12. 集成测试
  - 使用真实的美团导出文件（资源/商品的类目信息.xlsx）测试完整流程
  - 测试预览功能
  - 测试导入功能
  - 验证错误报告的准确性
  - _需求: 所有需求_

- [ ]* 12.1 编写兼容性属性测试
  - **属性 15: 标准格式兼容性**
  - **验证: 需求 5.1**
  - 使用标准格式文件测试，验证结果与之前一致

- [ ] 13. 性能测试和优化
  - 测试3000行数据的处理时间
  - 如果超过30秒，进行性能优化（流式处理、批量操作）
  - 测试内存使用情况
  - _需求: 6.1, 6.3_

- [ ] 14. 文档更新
  - 更新API文档，说明新的响应格式
  - 更新用户手册，说明美团格式自动识别功能
  - 添加使用示例和常见问题
  - _需求: 可用性_

- [ ] 15. 最终验收测试
  - 确保所有测试通过
  - 验证所有需求都已实现
  - 检查代码质量和文档完整性
  - 准备部署

## 实现顺序说明

1. **第1-4步**：核心组件实现（格式检测、解析、验证）
2. **第5-6步**：集成到ExcelService
3. **第7-8步**：更新Controller接口
4. **第9步**：配置化支持
5. **第10-11步**：前端和数据库更新
6. **第12-15步**：测试、优化、文档

## 注意事项

- 每个核心功能实现后立即编写对应的属性测试
- 保持向后兼容性，不影响现有的标准格式导入功能
- 错误处理要详细，帮助用户快速定位问题
- 性能优化要在功能正确的基础上进行
- 配置化设计便于后续扩展其他平台格式

## 预计工作量

- 核心功能实现：2-3天
- 测试编写：1-2天
- 前端更新：0.5-1天
- 集成测试和优化：1-2天
- 文档更新：0.5天
- **总计**：5-8天
