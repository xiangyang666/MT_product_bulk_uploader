# 需求文档 - 模板导出限制

## 简介

当用户删除美团模板后，系统仍然可以使用默认模板导出商品数据。这不符合预期，应该限制：删除模板后，必须重新上传模板才能导出。

## 术语表

- **美团模板**：用户上传的美团格式Excel模板文件，用于导出商品数据
- **默认模板**：系统内置的备用模板
- **模板导出**：使用模板生成包含商品数据的Excel文件
- **模板删除**：用户删除已上传的模板文件
- **导出限制**：删除模板后禁止导出操作

## 需求

### 需求 1：删除模板后禁止导出

**用户故事**：作为商家，当我删除了美团模板后，我希望系统不允许导出商品数据，直到我重新上传新的模板。

#### 验收标准

1. WHEN 用户删除美团模板 THEN 系统应标记该商家没有可用模板
2. WHEN 商家没有可用模板且尝试导出 THEN 系统应拒绝导出请求
3. WHEN 导出请求被拒绝 THEN 系统应返回明确的错误信息"请先上传美团模板"
4. WHEN 用户重新上传模板 THEN 系统应允许导出操作
5. WHEN 商家有多个模板且删除其中一个 THEN 系统应使用最新的剩余模板

### 需求 2：导出前模板检查

**用户故事**：作为系统，我需要在导出前检查模板是否存在，确保不会使用默认模板作为回退方案。

#### 验收标准

1. WHEN 系统接收到导出请求 THEN 系统应首先检查商家是否有可用模板
2. WHEN 商家没有可用模板 THEN 系统应立即返回错误，不尝试使用默认模板
3. WHEN 商家有可用模板但文件损坏 THEN 系统应返回错误"模板文件损坏，请重新上传"
4. WHEN 商家有可用模板但文件不存在 THEN 系统应返回错误"模板文件丢失，请重新上传"
5. WHEN 模板检查通过 THEN 系统应继续执行导出操作

### 需求 3：前端导出按钮状态管理

**用户故事**：作为商家，我希望在没有模板时，导出按钮应该被禁用或显示提示，避免我点击后才发现无法导出。

#### 验收标准

1. WHEN Upload.vue页面开始加载 THEN 系统应显示loading状态，按钮应处于禁用状态
2. WHEN 页面加载时 THEN 系统应调用模板状态API检查商家是否有可用的美团模板
3. WHEN 模板状态API返回结果 THEN 系统应隐藏loading状态
4. WHEN 商家没有可用模板 THEN "生成全部商品模板"按钮应保持禁用状态
5. WHEN 商家有可用模板 THEN "生成全部商品模板"按钮应变为可用状态
6. WHEN 鼠标悬停在禁用的导出按钮上 THEN 系统应显示提示"请先在模板管理中上传美团模板"
7. WHEN 商家上传模板成功 THEN 导出按钮应自动变为可用状态
8. WHEN 商家删除最后一个美团模板 THEN 导出按钮应自动变为禁用状态
9. WHEN 按钮禁用时 THEN 提示文本应从"将使用您在模板管理中上传的美团模板"改为"请先在模板管理中上传美团模板"
10. WHEN 模板状态API调用失败 THEN 系统应隐藏loading并显示错误提示


### 需求 4：清晰的错误提示

**用户故事**：作为商家，当我尝试导出但没有模板时，我希望看到清晰的错误提示和解决方案指引。

#### 验收标准

1. WHEN 导出失败因为没有模板 THEN 系统应显示错误消息"无法导出：未找到美团模板"
2. WHEN 显示错误消息 THEN 系统应提供操作指引"请前往模板管理上传美团模板"
3. WHEN 错误消息显示 THEN 系统应提供"前往模板管理"按钮链接到模板管理页面
4. WHEN 用户点击"前往模板管理"按钮 THEN 系统应跳转到Template.vue页面
5. WHEN 错误发生 THEN 系统应记录日志包含商家ID和错误原因

### 需求 5：移除默认模板回退机制

**用户故事**：作为开发者，我需要移除系统在找不到用户模板时自动使用默认模板的回退逻辑。

#### 验收标准

1. WHEN 系统查找用户模板失败 THEN 系统应抛出异常而不是使用默认模板
2. WHEN 模板文件读取失败 THEN 系统应抛出异常而不是使用默认模板
3. WHEN 模板文件格式错误 THEN 系统应抛出异常而不是使用默认模板
4. WHEN 异常抛出 THEN 系统应包含详细的错误信息
5. WHEN 异常被捕获 THEN 系统应返回HTTP 400错误和错误详情

### 需求 6：模板状态API

**用户故事**：作为前端应用，我需要一个API来查询商家的模板状态，以便动态控制UI元素。

#### 验收标准

1. WHEN 前端调用模板状态API THEN 系统应返回商家是否有可用的美团模板
2. WHEN 商家有可用的美团模板 THEN API应返回hasTemplate=true，以及模板名称、上传时间、文件大小
3. WHEN 商家没有可用的美团模板 THEN API应返回hasTemplate=false
4. WHEN 商家有多个美团模板 THEN API应返回最新上传的模板信息
5. WHEN API调用失败 THEN 系统应返回适当的HTTP错误码和错误信息
6. WHEN 模板状态改变 THEN 前端应能够重新调用API获取最新状态
7. WHEN API响应时间超过2秒 THEN 系统应记录性能警告日志

## 非功能性需求

### 用户体验要求
- 错误提示清晰明确
- 提供操作指引和快捷链接
- 按钮状态实时反映模板可用性

### 安全性要求
- 只允许商家查询和操作自己的模板
- 防止未授权的导出操作

### 性能要求
- 模板检查时间 ≤ 100毫秒
- 不影响正常导出流程的性能

### 可维护性要求
- 错误处理逻辑清晰
- 日志记录完整
- 易于调试和排查问题


### 需求 7：受影响的页面和功能

**用户故事**：作为开发者，我需要明确哪些页面和功能需要进行模板检查和限制。

#### 验收标准

1. WHEN Upload.vue页面的"生成全部商品模板"按钮被点击 THEN 系统应检查模板是否存在
2. WHEN 任何调用generateMeituanTemplate API的功能 THEN 系统应先检查模板
3. WHEN 模板管理页面删除美团模板 THEN 系统应通知Upload.vue页面更新按钮状态
4. WHEN 模板管理页面上传美团模板 THEN 系统应通知Upload.vue页面更新按钮状态
5. WHEN 系统检测到模板状态变化 THEN 所有相关页面应同步更新UI状态


### 需求 8：页面加载体验优化

**用户故事**：作为商家，我希望页面加载时有清晰的loading状态，避免在数据未加载完成时误操作。

#### 验收标准

1. WHEN Upload.vue页面开始加载 THEN 系统应在按钮区域显示loading骨架屏或加载动画
2. WHEN 正在加载模板状态 THEN 按钮应显示为禁用状态且不可点击
3. WHEN 正在加载商品统计数据 THEN 统计信息区域应显示loading状态
4. WHEN 所有必需的API调用完成 THEN 系统应隐藏所有loading状态
5. WHEN loading状态显示 THEN 应有视觉反馈（如旋转图标、骨架屏等）
6. WHEN 任一API调用超时（>5秒） THEN 系统应显示错误提示并允许用户重试
7. WHEN 用户刷新页面 THEN 系统应重新执行完整的加载流程
