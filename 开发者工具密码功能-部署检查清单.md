# 开发者工具密码功能 - 部署检查清单

## 部署前检查

### 1. 代码检查
- [x] 所有后端文件已创建
- [x] 所有前端文件已创建
- [x] 数据库迁移脚本已准备
- [x] 代码编译无错误
- [x] 代码已提交到版本控制

### 2. 文档检查
- [x] 使用说明文档已完成
- [x] 测试指南已完成
- [x] 实现总结已完成
- [x] 部署检查清单已完成

### 3. 依赖检查
- [ ] 后端依赖已安装（Spring Security, BCrypt）
- [ ] 前端依赖已安装（Element Plus）
- [ ] 数据库连接正常

## 部署步骤

### 步骤 1: 数据库迁移

```bash
# 连接到数据库
mysql -u root -p

# 选择数据库
use meituan_product;

# 执行迁移脚本
source database-migration-dev-tools-password.sql;

# 验证表已创建
SHOW TABLES LIKE 'dev_tools_config';

# 查看表结构
DESC dev_tools_config;
```

**检查点**:
- [ ] 表 `dev_tools_config` 已创建
- [ ] 表结构正确（8个字段）
- [ ] 索引 `idx_config_key` 已创建

### 步骤 2: 后端部署

```bash
# 进入后端目录
cd meituan-backend

# 清理并编译
mvn clean package -DskipTests

# 检查编译结果
ls -lh target/*.jar

# 备份旧版本（如果存在）
cp target/meituan-product-backend.jar target/meituan-product-backend.jar.backup

# 停止后端服务
# 方法1: 如果使用 systemd
sudo systemctl stop meituan-backend

# 方法2: 如果使用 screen/tmux
# 找到进程并停止

# 方法3: 如果使用 Java 进程
# kill -15 $(ps aux | grep 'meituan-product-backend' | grep -v grep | awk '{print $2}')

# 启动后端服务
# 方法1: 使用 systemd
sudo systemctl start meituan-backend

# 方法2: 使用 nohup
# nohup java -jar target/meituan-product-backend.jar > backend.log 2>&1 &

# 检查服务状态
sudo systemctl status meituan-backend
# 或
# ps aux | grep meituan-product-backend

# 查看日志
tail -f logs/application.log
```

**检查点**:
- [ ] 编译成功，无错误
- [ ] JAR 文件已生成
- [ ] 服务启动成功
- [ ] 日志无错误信息
- [ ] 端口 8080 已监听

### 步骤 3: 后端 API 验证

```bash
# 获取登录 token（使用任意账号）
TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin-plus","password":"YOUR_PASSWORD"}' \
  | jq -r '.data.token')

echo "Token: $TOKEN"

# 测试密码状态查询 API
curl -s http://localhost:8080/api/dev-tools/password/status \
  -H "Authorization: Bearer $TOKEN" | jq .

# 预期输出:
# {
#   "code": 200,
#   "message": "success",
#   "data": {
#     "hasPassword": false
#   }
# }
```

**检查点**:
- [ ] 登录 API 正常
- [ ] 状态查询 API 返回正确
- [ ] 响应格式正确

### 步骤 4: 前端部署

```bash
# 进入前端目录
cd meituan-frontend

# 安装依赖（如果需要）
npm install

# 构建生产版本
npm run build

# 检查构建结果
ls -lh dist/

# 备份旧版本（如果存在）
mv /var/www/meituan-frontend /var/www/meituan-frontend.backup

# 部署新版本
cp -r dist /var/www/meituan-frontend

# 或者使用 rsync
# rsync -av --delete dist/ /var/www/meituan-frontend/

# 设置权限
sudo chown -R www-data:www-data /var/www/meituan-frontend
sudo chmod -R 755 /var/www/meituan-frontend

# 重启 Nginx（如果需要）
sudo systemctl reload nginx
```

**检查点**:
- [ ] 构建成功，无错误
- [ ] dist 目录已生成
- [ ] 文件已部署到服务器
- [ ] 权限设置正确
- [ ] Nginx 配置正确

### 步骤 5: 前端功能验证

**手动测试**:

1. 访问系统
   - [ ] 页面正常加载
   - [ ] 无 JavaScript 错误

2. 使用 admin-plus 登录
   - [ ] 登录成功
   - [ ] 进入成员管理页面
   - [ ] 看到"开发者工具设置"按钮

3. 设置密码
   - [ ] 点击"开发者工具设置"按钮
   - [ ] 对话框正常弹出
   - [ ] 输入密码: `test123456`
   - [ ] 确认密码: `test123456`
   - [ ] 点击"确定"
   - [ ] 显示"开发者工具密码设置成功"

4. 测试拦截
   - [ ] 按 F12 键
   - [ ] 弹出密码输入对话框
   - [ ] 输入错误密码
   - [ ] 显示"密码错误"
   - [ ] 输入正确密码
   - [ ] 显示"密码验证通过"
   - [ ] 显示"请再次按 F12 或右键打开开发者工具"
   - [ ] 3秒内再次按 F12
   - [ ] 开发者工具成功打开

5. 测试右键菜单
   - [ ] 刷新页面
   - [ ] 点击右键
   - [ ] 弹出密码输入对话框
   - [ ] 输入正确密码
   - [ ] 3秒内再次点击右键
   - [ ] 显示浏览器右键菜单

6. 测试其他快捷键
   - [ ] Ctrl+Shift+I 被拦截
   - [ ] Ctrl+Shift+J 被拦截
   - [ ] Ctrl+Shift+C 被拦截

### 步骤 6: 权限验证

1. 使用非 admin-plus 账号登录
   - [ ] 进入成员管理页面
   - [ ] 不显示"开发者工具设置"按钮

2. API 权限测试
   ```bash
   # 使用非 admin-plus 账号的 token
   curl -X POST http://localhost:8080/api/dev-tools/password \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer $NON_ADMIN_TOKEN" \
     -d '{"password": "hacker123"}'
   
   # 预期: 返回权限不足错误
   ```
   - [ ] 返回权限不足错误
   - [ ] 密码未被修改

### 步骤 7: 性能测试

```bash
# 测试密码验证响应时间
time curl -s -X POST http://localhost:8080/api/dev-tools/password/verify \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"password": "test123456"}' > /dev/null

# 预期: 响应时间 < 500ms
```

**检查点**:
- [ ] 密码验证响应时间 < 500ms
- [ ] 页面加载速度正常
- [ ] 无明显性能下降

### 步骤 8: 安全测试

```bash
# SQL 注入测试
curl -X POST http://localhost:8080/api/dev-tools/password/verify \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"password": "test\" OR \"1\"=\"1"}'

# 预期: 返回密码验证失败

# XSS 测试
curl -X POST http://localhost:8080/api/dev-tools/password \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -d '{"password": "<script>alert(\"XSS\")</script>"}'

# 预期: 密码被正常保存（作为普通字符串）
```

**检查点**:
- [ ] SQL 注入测试通过
- [ ] XSS 测试通过
- [ ] 无安全漏洞

### 步骤 9: 回归测试

测试其他功能是否正常：

- [ ] 商品管理功能正常
- [ ] 批量导入功能正常
- [ ] 模板管理功能正常
- [ ] 成员管理其他功能正常
- [ ] 用户登录/登出正常

### 步骤 10: 浏览器兼容性测试

- [ ] Chrome 最新版测试通过
- [ ] Firefox 最新版测试通过
- [ ] Edge 最新版测试通过
- [ ] Safari 最新版测试通过（如果有 Mac）

## 部署后验证

### 数据库验证

```sql
-- 查看配置表
SELECT * FROM dev_tools_config;

-- 查看密码是否已加密
SELECT 
    config_key,
    LEFT(config_value, 10) as password_prefix,
    LENGTH(config_value) as password_length,
    created_by,
    created_at
FROM dev_tools_config
WHERE config_key = 'dev_tools_password';

-- 预期: password_length 应该是 60（BCrypt 哈希长度）
```

### 日志验证

```bash
# 查看后端日志
tail -f logs/application.log | grep -i "dev.*tools"

# 预期看到的日志:
# - 设置开发者工具密码，操作人：admin-plus
# - 创建开发者工具密码配置成功
# - 验证开发者工具密码
# - 密码验证结果：通过/失败
```

### 监控验证

```bash
# 检查服务状态
sudo systemctl status meituan-backend
sudo systemctl status nginx

# 检查端口监听
netstat -tlnp | grep 8080
netstat -tlnp | grep 80

# 检查进程
ps aux | grep java
ps aux | grep nginx

# 检查磁盘空间
df -h

# 检查内存使用
free -h
```

## 回滚计划

如果部署出现问题，按以下步骤回滚：

### 回滚后端

```bash
# 停止服务
sudo systemctl stop meituan-backend

# 恢复备份
cp target/meituan-product-backend.jar.backup target/meituan-product-backend.jar

# 启动服务
sudo systemctl start meituan-backend

# 验证
sudo systemctl status meituan-backend
```

### 回滚前端

```bash
# 恢复备份
rm -rf /var/www/meituan-frontend
mv /var/www/meituan-frontend.backup /var/www/meituan-frontend

# 重启 Nginx
sudo systemctl reload nginx
```

### 回滚数据库

```sql
-- 删除配置表（如果需要）
DROP TABLE IF EXISTS dev_tools_config;
```

## 常见问题处理

### 问题 1: 密码对话框不弹出

**排查**:
```bash
# 检查浏览器控制台
# 查看是否有 JavaScript 错误

# 检查 API 状态
curl http://localhost:8080/api/dev-tools/password/status \
  -H "Authorization: Bearer $TOKEN"
```

**解决**:
- 清除浏览器缓存
- 检查 devToolsProtection.js 是否正确加载
- 确认 App.vue 中的初始化代码是否执行

### 问题 2: 密码验证失败

**排查**:
```bash
# 查看后端日志
tail -f logs/application.log | grep -i "password"

# 检查数据库
mysql -u root -p meituan_product -e \
  "SELECT * FROM dev_tools_config WHERE config_key='dev_tools_password';"
```

**解决**:
- 确认密码是否正确
- 检查 BCrypt 加密是否正常
- 重新设置密码

### 问题 3: 权限错误

**排查**:
```bash
# 检查用户角色
mysql -u root -p meituan_product -e \
  "SELECT username, role FROM user WHERE username='admin-plus';"

# 检查 JWT token
# 解码 token 查看用户信息
```

**解决**:
- 确认使用的是 admin-plus 账号
- 重新登录获取新 token
- 检查后端权限验证逻辑

## 部署完成确认

- [ ] 数据库表已创建
- [ ] 后端服务运行正常
- [ ] 前端页面访问正常
- [ ] admin-plus 可以设置密码
- [ ] 非 admin-plus 看不到设置按钮
- [ ] F12 键被正确拦截
- [ ] 右键菜单被正确拦截
- [ ] 其他快捷键被正确拦截
- [ ] 密码验证功能正常
- [ ] 临时解锁功能正常
- [ ] 性能测试通过
- [ ] 安全测试通过
- [ ] 回归测试通过
- [ ] 浏览器兼容性测试通过
- [ ] 文档已更新
- [ ] 团队已培训

## 部署签字

- 部署人员: ________________
- 部署日期: ________________
- 验证人员: ________________
- 验证日期: ________________
- 批准人员: ________________
- 批准日期: ________________

---

**注意事项**:
1. 部署前务必备份数据库和代码
2. 建议在测试环境先验证
3. 生产环境部署建议在低峰期进行
4. 部署后持续监控系统运行状态
5. 保留回滚方案，以备不时之需
