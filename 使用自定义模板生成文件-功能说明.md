# 使用自定义模板生成文件 - 功能说明

## 🎯 功能描述

现在"批量上传"功能会使用您在"模板管理"中上传的自定义模板来生成Excel文件，而不是使用固定的表头。

---

## 📋 使用流程

### 步骤1：上传自定义模板

1. **进入"模板管理"页面**
2. **点击"上传模板"按钮**
3. **填写信息：**
   - 模板名称：例如"美团商品上传模板"
   - 模板类型：选择"美团模板"
   - 模板文件：上传您的Excel模板文件

4. **模板文件要求：**
   - 第一行必须是表头
   - 表头可以是任意名称，例如：
     ```
     商品名称 | 类目ID | 价格 | 库存 | 商品描述 | 商品图片URL
     ```
   - 支持格式：.xlsx, .xls, .csv
   - 文件大小：不超过10MB

### 步骤2：生成模板文件

1. **进入"批量上传"页面**
2. **勾选要导出的商品**
3. **点击"生成模板"按钮**
4. **系统会：**
   - 自动查找您上传的"美团模板"
   - 使用模板的表头结构
   - 填充选中商品的数据
   - 生成Excel文件并下载

---

## 🔍 表头字段映射规则

系统会智能匹配表头名称和商品字段：

| 表头名称（支持的关键词） | 对应商品字段 | 示例值 |
|---|---|---|
| 包含"商品名称"、"名称" | 商品名称 | 苹果 iPhone 15 Pro |
| 包含"类目"、"分类" | 类目ID | 2000010001 |
| 包含"价格" | 价格 | 7999.00 |
| 包含"库存" | 库存 | 100 |
| 包含"描述"、"说明" | 商品描述 | 全新苹果iPhone... |
| 包含"图片"、"URL" | 图片URL | https://example.com/... |

### 匹配规则说明

- **不区分大小写**：`商品名称`、`PRODUCT_NAME`、`productName` 都能识别
- **支持中英文**：中文表头和英文表头都支持
- **模糊匹配**：只要表头包含关键词即可，例如"商品名称（必填）"也能识别
- **未匹配的列**：如果表头无法匹配任何字段，该列会留空

---

## 📝 示例

### 示例1：标准美团格式

**您的模板表头：**
```
商品名称 | 类目ID | 价格 | 库存 | 商品描述 | 商品图片URL
```

**生成的文件：**
```
商品名称              | 类目ID      | 价格    | 库存 | 商品描述           | 商品图片URL
苹果 iPhone 15 Pro   | 2000010001  | 7999.00 | 100  | 全新苹果iPhone... | https://...
华为 Mate 60 Pro     | 2000010001  | 6999.00 | 80   | 华为Mate 60...    | https://...
```

### 示例2：自定义格式

**您的模板表头：**
```
产品名称 | 分类编号 | 售价 | 数量 | 备注
```

**生成的文件：**
```
产品名称              | 分类编号    | 售价    | 数量 | 备注
苹果 iPhone 15 Pro   | 2000010001  | 7999.00 | 100  | 全新苹果iPhone...
华为 Mate 60 Pro     | 2000010001  | 6999.00 | 80   | 华为Mate 60...
```

### 示例3：包含额外列

**您的模板表头：**
```
序号 | 商品名称 | 类目ID | 价格 | 备注栏
```

**生成的文件：**
```
序号 | 商品名称              | 类目ID      | 价格    | 备注栏
     | 苹果 iPhone 15 Pro   | 2000010001  | 7999.00 |
     | 华为 Mate 60 Pro     | 2000010001  | 6999.00 |
```
（序号和备注栏无法匹配，留空）

---

## ⚙️ 技术实现

### 工作流程

```
1. 用户点击"生成模板"
   ↓
2. 后端查询商家的"美团模板"（最新上传的）
   ↓
3. 从MinIO下载模板文件
   ↓
4. 读取模板的表头结构
   ↓
5. 创建新的Excel文件
   ↓
6. 复制模板的表头（包括样式）
   ↓
7. 根据表头名称智能填充商品数据
   ↓
8. 返回生成的Excel文件
```

### 回退机制

如果出现以下情况，系统会自动使用默认模板：

1. 商家没有上传"美团模板"
2. 模板文件损坏或无法读取
3. 模板文件没有表头
4. 下载模板文件失败

---

## 🎨 样式保留

生成的文件会保留模板的样式：

- ✅ 表头样式（字体、颜色、背景色）
- ✅ 列宽
- ✅ 单元格格式
- ✅ 边框样式

---

## 🔧 配置说明

### 模板类型

在上传模板时，必须选择正确的模板类型：

- **导入模板（IMPORT）**：用于批量导入商品
- **导出模板（EXPORT）**：用于导出商品数据
- **美团模板（MEITUAN）**：用于生成美团上传文件 ⭐

**重要：** 只有类型为"美团模板"的模板才会被用于生成上传文件！

### 多个模板

- 如果上传了多个"美团模板"，系统会使用**最新上传的那个**
- 建议只保留一个"美团模板"，避免混淆

---

## 📊 对比：修改前 vs 修改后

### 修改前

**固定表头：**
```
商品名称 | 类目ID | 价格 | 库存 | 商品描述 | 商品图片URL
```

- ❌ 无法自定义表头
- ❌ 必须使用系统预设的字段顺序
- ❌ 无法添加额外的列

### 修改后

**灵活表头：**
```
您可以使用任意表头，例如：
- 产品名称 | 分类 | 售价 | 数量
- 商品 | 类目 | 价格 | 库存 | 说明
- Name | Category | Price | Stock
```

- ✅ 完全自定义表头
- ✅ 灵活的字段顺序
- ✅ 可以添加额外的列（会留空）
- ✅ 保留模板样式

---

## 🚀 快速开始

### 1. 准备模板文件

创建一个Excel文件，第一行写上表头：

```
商品名称 | 类目ID | 价格 | 库存 | 商品描述 | 商品图片URL
```

### 2. 上传模板

- 进入"模板管理"
- 点击"上传模板"
- 选择"美团模板"类型
- 上传文件

### 3. 生成文件

- 进入"批量上传"
- 勾选商品
- 点击"生成模板"
- 下载文件

### 4. 上传到美团

- 打开美团商家后台
- 使用生成的文件批量上传商品

---

## ❓ 常见问题

### Q1: 如果我没有上传模板会怎样？

**A:** 系统会使用默认模板，表头为：
```
商品名称 | 类目ID | 价格 | 库存 | 商品描述 | 商品图片URL
```

### Q2: 我可以使用英文表头吗？

**A:** 可以！系统支持中英文表头，例如：
```
product_name | category_id | price | stock
```

### Q3: 表头顺序重要吗？

**A:** 不重要！系统会根据表头名称智能匹配，不依赖顺序。

### Q4: 我可以添加额外的列吗？

**A:** 可以！但系统无法识别的列会留空。例如：
```
商品名称 | 类目ID | 价格 | 备注 | 审核状态
```
"备注"和"审核状态"列会留空。

### Q5: 如何修改模板？

**A:** 
1. 在"模板管理"中删除旧模板
2. 上传新的模板文件
3. 系统会自动使用最新的模板

### Q6: 模板样式会保留吗？

**A:** 会！表头的字体、颜色、背景色、列宽等样式都会保留。

---

## 🔄 更新日志

### 2026-02-09

- ✅ 实现使用用户上传的模板生成文件
- ✅ 支持智能表头匹配
- ✅ 保留模板样式
- ✅ 添加回退机制（无模板时使用默认）

---

## 📝 相关文件

### 后端文件
- `ProductService.java` - 修改生成模板方法
- `ExcelService.java` - 添加使用用户模板的方法

### 前端文件
- `Template.vue` - 模板管理页面
- `Upload.vue` - 批量上传页面

---

**功能状态**: ✅ 已实现  
**更新日期**: 2026-02-09  
**需要重启**: 是（需要重启后端服务）
