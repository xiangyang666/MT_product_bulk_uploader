# 服务器配置 - 大文件上传优化

## 问题描述

上传大文件（如 dmg/exe 安装包）时出现以下错误：
- `Network Error`
- `ERR_CONNECTION_RESET`
- 文件上传到 100% 后服务器无响应

## 原因分析

1. **Nginx 超时配置不足**：默认超时时间太短，大文件上传时连接被断开
2. **Nginx 上传大小限制**：默认 1MB，需要增加到 500MB
3. **后端处理超时**：上传到 MinIO 时可能超时

## 解决方案

### 1. Nginx 配置优化

需要在 Nginx 配置文件中添加以下配置：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 客户端请求体最大大小（上传文件大小限制）
    client_max_body_size 500M;
    
    # 客户端请求体缓冲区大小
    client_body_buffer_size 128k;
    
    # 客户端请求体超时时间
    client_body_timeout 600s;
    
    # 发送超时时间
    send_timeout 600s;
    
    # 代理连接超时
    proxy_connect_timeout 600s;
    
    # 代理发送超时
    proxy_send_timeout 600s;
    
    # 代理读取超时（重要！）
    proxy_read_timeout 600s;
    
    # 代理缓冲区大小
    proxy_buffer_size 64k;
    proxy_buffers 4 64k;
    proxy_busy_buffers_size 128k;
    
    # 临时文件写入大小
    proxy_temp_file_write_size 128k;
    
    # 禁用代理缓冲（对于大文件上传）
    proxy_request_buffering off;

    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 2. 配置文件位置

**Linux (Ubuntu/Debian):**
```bash
/etc/nginx/sites-available/default
# 或
/etc/nginx/conf.d/default.conf
```

**修改后重启 Nginx:**
```bash
sudo nginx -t  # 测试配置
sudo systemctl restart nginx  # 重启 Nginx
```

### 3. Spring Boot 配置（已完成）

`application.yml` 中已配置：
```yaml
spring:
  servlet:
    multipart:
      max-file-size: 500MB
      max-request-size: 500MB
      enabled: true
```

### 4. MinIO 配置优化

如果 MinIO 也有超时问题，可以调整 MinIO 的配置：

```bash
# 设置 MinIO 的超时时间
export MINIO_API_REQUESTS_MAX=600
export MINIO_API_REQUESTS_DEADLINE=10m
```

## 快速修复步骤

### 方案 A：修改 Nginx 配置（推荐）

1. SSH 登录到服务器：
```bash
ssh root@106.55.102.48
```

2. 编辑 Nginx 配置：
```bash
vi /etc/nginx/sites-available/default
```

3. 在 `server` 块中添加上述配置

4. 测试并重启：
```bash
nginx -t
systemctl restart nginx
```

### 方案 B：临时增加超时（快速测试）

如果无法修改 Nginx，可以在前端增加重试机制：

```javascript
// 在 uploadVersion API 中
timeout: 1200000, // 20分钟超时
```

但这只是临时方案，根本问题还是需要配置 Nginx。

## 验证方法

1. 修改配置后，重新上传文件
2. 查看 Nginx 错误日志：
```bash
tail -f /var/log/nginx/error.log
```

3. 查看后端日志：
```bash
# 查看 Spring Boot 日志
tail -f /path/to/your/app.log
```

## 预期效果

配置完成后：
- ✅ 支持上传 500MB 以内的文件
- ✅ 上传过程不会超时断开
- ✅ 多个文件可以顺序上传成功
- ✅ 上传到 100% 后服务器正常响应

## 注意事项

1. **磁盘空间**：确保服务器有足够的磁盘空间存储上传的文件
2. **内存**：大文件上传会占用一定内存，确保服务器内存充足
3. **网络带宽**：上传速度取决于网络带宽，大文件可能需要几分钟
4. **MinIO 存储**：确保 MinIO 有足够的存储空间

## 当前服务器信息

- 服务器 IP: `106.55.102.48`
- 后端端口: `8080`
- MinIO 端口: `9000`
- 数据库端口: `3306`
