# 商品重复导入问题 - 解决方案

## 问题描述

用户导入了一个包含 3570 条数据的文件，但商品总数显示为 7500 条（约2倍），说明数据被重复导入了。

## 问题原因分析

可能的原因：

1. **用户重复点击导入按钮**
   - 网络较慢时，用户可能在第一次请求还未完成时再次点击了"确认导入"按钮
   - 虽然前端有 `importing` 状态控制，但可能不够严格

2. **后端没有去重机制**
   - 后端导入时没有检查商品是否已存在
   - 没有基于 SKU ID、商品名称等唯一标识进行去重

3. **之前已有数据**
   - 数据库中可能已经存在之前导入的商品数据

## 已实施的修复

### 1. 前端防重复点击增强

**文件**: `meituan-frontend/src/views/Import.vue`

**修改内容**:
- 在"确认导入"按钮上添加 `:disabled="importing"` 属性
- 在"上一步"按钮上也添加 `:disabled="importing"` 属性，防止导入过程中返回

```vue
<el-button 
  type="primary" 
  :loading="importing"
  :disabled="importing"
  @click="handleImport"
>
  {{ importing ? '导入中...' : '确认导入' }}
</el-button>
```

### 2. 确认对话框数量显示修复

**问题**: 确认对话框显示的是预览数据的数量（20条），而不是实际文件的总数量（3750条）

**修复**: 将 `previewData.value.length` 改为 `previewResult.value.totalCount`

```javascript
await ElMessageBox.confirm(
  `确认导入 ${previewResult.value.totalCount} 条商品数据吗？${previewResult.value.hasMoreData ? '（预览仅显示前20行，实际将导入全部数据）' : ''}`,
  '确认导入',
  // ...
)
```

## 数据清理方案

### 方案1：检查重复数据

运行 `check-duplicate-products.sql` 查看是否有重复数据：

```sql
-- 查看重复的商品
SELECT 
    product_name,
    category_id,
    sku_id,
    COUNT(*) as duplicate_count
FROM products
WHERE merchant_id = 1
GROUP BY product_name, category_id, sku_id
HAVING COUNT(*) > 1;
```

### 方案2：删除重复数据

使用 `remove-duplicate-products.sql` 清理重复数据：

**选项A - 保留最早导入的记录**（推荐）:
```sql
DELETE p1 FROM products p1
INNER JOIN products p2 ON 
    p1.product_name = p2.product_name 
    AND p1.category_id = p2.category_id 
    AND p1.sku_id = p2.sku_id
    AND p1.merchant_id = p2.merchant_id
    AND p1.id > p2.id
WHERE p1.merchant_id = 1;
```

**选项B - 删除今天导入的所有数据**:
```sql
DELETE FROM products 
WHERE merchant_id = 1 
AND DATE(created_time) = CURDATE();
```

**选项C - 清空所有商品数据**:
- 在前端使用"清空商品"功能
- 需要管理员权限和访问令牌（默认：admin123）

## 后续建议

### 1. 添加唯一索引（推荐）

在数据库中为商品添加唯一索引，防止重复插入：

```sql
-- 为 SKU ID 添加唯一索引
ALTER TABLE products 
ADD UNIQUE INDEX idx_merchant_sku (merchant_id, sku_id);

-- 或者为商品名称+类目ID添加唯一索引
ALTER TABLE products 
ADD UNIQUE INDEX idx_merchant_product (merchant_id, product_name, category_id);
```

**注意**: 添加唯一索引前需要先清理现有的重复数据。

### 2. 后端添加去重逻辑

在 `ProductService.importFromExcel` 方法中添加去重检查：

```java
// 导入前检查是否已存在
List<Product> existingProducts = productMapper.selectBySkuIds(skuIds);
if (!existingProducts.isEmpty()) {
    // 提示用户或自动跳过重复数据
}
```

### 3. 前端添加导入确认提示

在导入前显示更明确的提示：
- 显示将要导入的数据量
- 提示是否会覆盖现有数据
- 提供"追加"或"覆盖"选项

## 操作步骤

1. **检查当前数据**
   ```bash
   # 在数据库中运行
   SELECT COUNT(*) FROM products WHERE merchant_id = 1;
   ```

2. **检查是否有重复**
   ```bash
   # 运行 check-duplicate-products.sql
   ```

3. **清理重复数据**（根据检查结果选择）
   - 如果有重复：运行 `remove-duplicate-products.sql` 中的删除语句
   - 如果想重新开始：使用前端"清空商品"功能

4. **重新导入**
   - 确保数据已清理
   - 使用修复后的导入功能重新导入文件
   - 注意：只点击一次"确认导入"按钮

## 验证修复

1. 清空现有商品数据
2. 导入测试文件（例如100条数据）
3. 检查数据库中的商品总数是否正确（应该是100条，不是200条）
4. 尝试再次导入相同文件，观察是否会重复

## 相关文件

- `meituan-frontend/src/views/Import.vue` - 批量导入页面（已修复）
- `check-duplicate-products.sql` - 检查重复数据的SQL脚本
- `remove-duplicate-products.sql` - 清理重复数据的SQL脚本
- `meituan-backend/src/main/java/com/meituan/product/service/ProductService.java` - 导入服务（待优化）

## 总结

当前已修复前端的防重复点击问题和确认对话框显示问题。建议：

1. 先清理现有的重复数据
2. 考虑在数据库层面添加唯一索引
3. 在后端添加去重逻辑
4. 重新导入数据进行验证
