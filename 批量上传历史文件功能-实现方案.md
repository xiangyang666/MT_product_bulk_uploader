# 批量上传历史文件功能 - 实现方案

## 功能描述

在批量上传页面显示历史生成的模板文件列表，用户可以：
- 查看最近生成的文件（文件名、大小、商品数量、生成时间）
- 下载历史文件
- 查看下载次数

## 实现步骤

### 1. 数据库准备

运行 `database-migration-generated-files.sql` 创建文件记录表：

```sql
CREATE TABLE IF NOT EXISTS generated_files (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    file_type VARCHAR(50) NOT NULL DEFAULT 'TEMPLATE',
    product_count INT NOT NULL DEFAULT 0,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at DATETIME NULL,
    download_count INT NOT NULL DEFAULT 0
);
```

### 2. 后端文件已创建

已创建以下文件：
- `GeneratedFile.java` - 实体类
- `GeneratedFileMapper.java` - Mapper
- `GeneratedFileDTO.java` - DTO
- `FileStorageService.java` - 文件存储服务

### 3. 修改 ProductService

需要在 `ProductService` 中注入 `FileStorageService` 并修改 `generateAllProductsTemplate` 方法：

```java
@RequiredArgsConstructor
public class ProductService {
    // ... 其他依赖
    private final FileStorageService fileStorageService;
    
    public byte[] generateAllProductsTemplate(Long merchantId) {
        // ... 现有代码生成 excelData
        
        // 生成文件名
        String timestamp = LocalDateTime.now()
            .format(DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss"));
        String fileName = String.format("meituan_all_products_%s.xlsx", timestamp);
        
        // 保存文件到服务器
        try {
            fileStorageService.saveTemplateFile(
                fileName, 
                excelData, 
                merchantId, 
                products.size()
            );
        } catch (Exception e) {
            log.error("保存文件记录失败", e);
            // 不影响主流程
        }
        
        return excelData;
    }
}
```

### 4. 添加控制器接口

在 `ProductController` 中添加两个新接口：

```java
/**
 * 获取历史生成文件列表
 */
@GetMapping("/generated-files/recent")
public ApiResponse<List<GeneratedFileDTO>> getRecentGeneratedFiles(
        @RequestParam(value = "merchantId", required = false, defaultValue = "1") Long merchantId,
        @RequestParam(value = "limit", required = false, defaultValue = "10") Integer limit) {
    try {
        List<GeneratedFileDTO> files = fileStorageService.getRecentFiles(merchantId, limit);
        return ApiResponse.success(files);
    } catch (Exception e) {
        log.error("获取历史文件失败", e);
        return ApiResponse.error(500, "获取历史文件失败");
    }
}

/**
 * 下载历史文件
 */
@GetMapping("/generated-files/{fileId}/download")
public ResponseEntity<byte[]> downloadGeneratedFile(@PathVariable Long fileId) {
    try {
        byte[] fileData = fileStorageService.getFileData(fileId);
        GeneratedFile file = fileStorageService.getFileById(fileId);
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);
        headers.setContentDispositionFormData("attachment", 
            URLEncoder.encode(file.getFileName(), "UTF-8"));
        
        return ResponseEntity.ok()
            .headers(headers)
            .body(fileData);
    } catch (Exception e) {
        log.error("下载文件失败", e);
        return ResponseEntity.status(500).build();
    }
}
```

### 5. 前端 API

在 `meituan-frontend/src/api/index.js` 添加：

```javascript
/**
 * 获取历史生成文件
 */
export const getRecentGeneratedFiles = (merchantId = 1, limit = 10) => {
  return request.get('/products/generated-files/recent', {
    params: { merchantId, limit }
  })
}

/**
 * 下载历史文件
 */
export const downloadGeneratedFile = (fileId) => {
  return request.get(`/products/generated-files/${fileId}/download`, {
    responseType: 'blob'
  })
}
```

### 6. 前端页面修改

在 `Upload.vue` 中添加历史文件区域：

```vue
<template>
  <!-- 现有内容 -->
  
  <!-- 历史文件区域 -->
  <div class="history-files-section">
    <div class="history-files-card">
      <div class="history-files-header">
        <h3>历史文件</h3>
        <span class="history-files-subtitle">最近生成的模板文件</span>
      </div>

      <div v-if="historyFiles.length === 0" class="empty-files">
        <el-icon><Document /></el-icon>
        <span>暂无历史文件</span>
      </div>

      <div v-else class="files-list">
        <div v-for="file in historyFiles" :key="file.id" class="file-item">
          <div class="file-icon">
            <el-icon><Document /></el-icon>
          </div>

          <div class="file-content">
            <div class="file-name">{{ file.fileName }}</div>
            <div class="file-meta">
              <span>{{ file.fileSizeFormatted }}</span>
              <span>{{ file.productCount }} 个商品</span>
              <span>{{ formatTime(file.createdAt) }}</span>
              <span>下载 {{ file.downloadCount }} 次</span>
            </div>
          </div>

          <el-button 
            type="primary" 
            size="small"
            @click="handleDownloadFile(file)"
            style="background-color: #FFD100; border-color: #FFD100; color: #333;"
          >
            <el-icon><Download /></el-icon>
            下载
          </el-button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { getRecentGeneratedFiles, downloadGeneratedFile } from '@/api/index.js'

const historyFiles = ref([])

const loadHistoryFiles = async () => {
  try {
    const response = await getRecentGeneratedFiles(1, 10)
    historyFiles.value = response.data || []
  } catch (error) {
    console.error('加载历史文件失败:', error)
  }
}

const handleDownloadFile = async (file) => {
  try {
    const blob = await downloadGeneratedFile(file.id)
    
    const url = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = file.fileName
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    window.URL.revokeObjectURL(url)
    
    ElMessage.success('文件下载成功')
    
    // 刷新列表（更新下载次数）
    loadHistoryFiles()
  } catch (error) {
    console.error('下载文件失败:', error)
    ElMessage.error('下载文件失败')
  }
}

const loadPageData = async () => {
  // ... 现有代码
  
  // 加载历史文件
  await loadHistoryFiles()
}

onMounted(() => {
  loadPageData()
})
</script>

<style scoped>
.history-files-section {
  margin: 0 24px 24px;
}

.history-files-card {
  background: white;
  border-radius: 16px;
  padding: 32px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  border: 1px solid rgba(0, 0, 0, 0.06);
}

.history-files-header {
  margin-bottom: 24px;
}

.history-files-header h3 {
  font-size: 18px;
  font-weight: 700;
  color: #1a1a1a;
  margin: 0 0 4px 0;
}

.history-files-subtitle {
  font-size: 13px;
  color: #6b7280;
  font-weight: 500;
}

.empty-files {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  color: #9ca3af;
  gap: 12px;
}

.empty-files .el-icon {
  font-size: 48px;
}

.files-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.file-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px;
  background: #fafbfc;
  border-radius: 10px;
  transition: all 0.2s;
  border: 1px solid rgba(0, 0, 0, 0.04);
}

.file-item:hover {
  background: #f3f4f6;
  transform: translateX(4px);
}

.file-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: rgba(255, 209, 0, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.file-icon .el-icon {
  font-size: 24px;
  color: #FFD100;
}

.file-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.file-name {
  font-size: 15px;
  color: #1a1a1a;
  font-weight: 600;
}

.file-meta {
  display: flex;
  gap: 16px;
  font-size: 13px;
  color: #6b7280;
}
</style>
```

## 配置说明

在 `application.yml` 或 `application.properties` 中配置：

```yaml
file:
  upload:
    template-path: ./uploads/templates/
    retention-days: 30
```

或

```properties
file.upload.template-path=./uploads/templates/
file.upload.retention-days=30
```

## 文件清理

可以添加定时任务清理过期文件：

```java
@Scheduled(cron = "0 0 2 * * ?") // 每天凌晨2点执行
public void cleanupExpiredFiles() {
    fileStorageService.cleanupExpiredFiles();
}
```

## 注意事项

1. **存储空间**: 确保服务器有足够的存储空间
2. **文件权限**: 确保应用有权限读写 `uploads/templates/` 目录
3. **过期清理**: 定期清理过期文件，避免占用过多空间
4. **并发下载**: 考虑添加下载限流，防止服务器压力过大
5. **文件安全**: 验证文件ID和商家ID，防止越权下载

## 优化建议

1. **CDN 加速**: 将文件上传到 OSS/CDN，提高下载速度
2. **压缩存储**: 对文件进行压缩存储，节省空间
3. **分页加载**: 历史文件较多时，添加分页功能
4. **搜索过滤**: 添加按日期、文件名搜索功能

## 测试步骤

1. 运行数据库迁移脚本
2. 重启后端服务
3. 生成一个模板文件
4. 查看历史文件区域是否显示
5. 点击下载按钮测试下载功能
6. 检查下载次数是否增加

## 总结

这个功能让用户可以方便地管理和下载历史生成的模板文件，提升了用户体验。文件会在服务器上保留30天，过期后自动清理。
