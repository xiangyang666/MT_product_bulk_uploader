# æ¸…ç©ºå•†å“500é”™è¯¯ä¿®å¤è¯´æ˜

**ä¿®å¤æ—¶é—´**: 2026-02-09

---

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·ç‚¹å‡»"æ¸…ç©ºå•†å“"æŒ‰é’®åï¼Œè¾“å…¥è®¿é—®ä»¤ç‰Œå¹¶ç¡®è®¤ï¼Œç³»ç»Ÿè¿”å›500é”™è¯¯ï¼š

```json
{
  "code": 500,
  "message": "ç³»ç»Ÿé”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜",
  "data": null,
  "timestamp": 1770641974349
}
```

---

## ğŸ” é—®é¢˜åŸå› 

### åç«¯æ¥å£è¦æ±‚

`ProductController.clearProducts()` æ–¹æ³•éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼š

```java
@DeleteMapping("/clear")
public ApiResponse<ClearResult> clearProducts(@RequestBody ClearRequest request) {
    if (request.getMerchantId() == null) {
        return ApiResponse.error(400, "å•†å®¶IDä¸èƒ½ä¸ºç©º");
    }
    
    if (request.getAccessToken() == null || request.getAccessToken().trim().isEmpty()) {
        return ApiResponse.error(400, "è®¿é—®ä»¤ç‰Œä¸èƒ½ä¸ºç©º");
    }
    
    // ...
}
```

**ClearRequest éœ€è¦çš„å­—æ®µ**:
- `merchantId` (Long) - å•†å®¶ID
- `accessToken` (String) - è®¿é—®ä»¤ç‰Œ

### å‰ç«¯è¯·æ±‚é—®é¢˜

å‰ç«¯åªä¼ é€’äº† `accessToken`ï¼Œç¼ºå°‘ `merchantId`ï¼š

**ä¿®æ”¹å‰**:
```javascript
const response = await request.delete('/products/clear', {
  data: {
    accessToken: clearForm.value.accessToken  // âŒ ç¼ºå°‘ merchantId
  }
})
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

åœ¨å‰ç«¯è¯·æ±‚ä¸­æ·»åŠ  `merchantId` å‚æ•°ï¼š

**ä¿®æ”¹å**:
```javascript
const response = await request.delete('/products/clear', {
  data: {
    merchantId: 1,  // âœ… æ·»åŠ é»˜è®¤å•†å®¶ID
    accessToken: clearForm.value.accessToken
  }
})
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### meituan-frontend/src/views/Upload.vue

**ä½ç½®**: `confirmClear` å‡½æ•°

**ä¿®æ”¹å†…å®¹**:
```javascript
// ç¡®è®¤æ¸…ç©º
const confirmClear = async () => {
  if (!clearForm.value.accessToken) {
    ElMessage.warning('è¯·è¾“å…¥è®¿é—®ä»¤ç‰Œ')
    return
  }

  clearing.value = true
  try {
    const response = await request.delete('/products/clear', {
      data: {
        merchantId: 1,  // ä½¿ç”¨é»˜è®¤å•†å®¶ID
        accessToken: clearForm.value.accessToken
      }
    })

    if (response.code === 200) {
      ElMessage.success(`æˆåŠŸæ¸…ç©º ${response.data.deletedCount} ä¸ªå•†å“`)
      clearDialogVisible.value = false
      currentPage.value = 1
      products.value = []
      hasMore.value = true
      fetchProducts()
    }
  } catch (error) {
    ElMessage.error(error.response?.data?.message || 'æ¸…ç©ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¿é—®ä»¤ç‰Œ')
  } finally {
    clearing.value = false
  }
}
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

1. è®¿é—®æ‰¹é‡ä¸Šä¼ é¡µé¢
2. ç‚¹å‡»"æ¸…ç©ºå•†å“"æŒ‰é’®
3. åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­è¾“å…¥è®¿é—®ä»¤ç‰Œï¼ˆé»˜è®¤ï¼šadmin123ï¼‰
4. ç‚¹å‡»"ç¡®è®¤æ¸…ç©º"æŒ‰é’®
5. éªŒè¯æ˜¯å¦æˆåŠŸæ¸…ç©ºå•†å“
6. éªŒè¯æ˜¯å¦æ˜¾ç¤ºæˆåŠŸæç¤ºï¼š"æˆåŠŸæ¸…ç©º X ä¸ªå•†å“"
7. éªŒè¯å•†å“åˆ—è¡¨æ˜¯å¦å·²æ¸…ç©º

---

## ğŸ“Š API æ¥å£è¯´æ˜

### æ¸…ç©ºå•†å“æ¥å£

**URL**: `DELETE /api/products/clear`

**è¯·æ±‚ä½“**:
```json
{
  "merchantId": 1,
  "accessToken": "admin123"
}
```

**æˆåŠŸå“åº”**:
```json
{
  "code": 200,
  "message": "æˆåŠŸæ¸…ç©º10æ¡å•†å“",
  "data": {
    "deletedCount": 10
  },
  "timestamp": 1770641974349
}
```

**é”™è¯¯å“åº”**:
```json
{
  "code": 400,
  "message": "å•†å®¶IDä¸èƒ½ä¸ºç©º",
  "data": null,
  "timestamp": 1770641974349
}
```

æˆ–

```json
{
  "code": 400,
  "message": "è®¿é—®ä»¤ç‰Œä¸èƒ½ä¸ºç©º",
  "data": null,
  "timestamp": 1770641974349
}
```

æˆ–

```json
{
  "code": 403,
  "message": "è®¿é—®ä»¤ç‰Œæ— æ•ˆ",
  "data": null,
  "timestamp": 1770641974349
}
```

---

## ğŸ”§ ç›¸å…³ä»£ç 

### åç«¯ ClearRequest DTO

```java
@Data
public class ClearRequest {
    private Long merchantId;
    private String accessToken;
}
```

### åç«¯ ClearResult DTO

```java
@Data
public class ClearResult {
    private Integer deletedCount;
}
```

### åç«¯ ProductService.clearAllProducts()

```java
public ClearResult clearAllProducts(Long merchantId, String accessToken) {
    // éªŒè¯è®¿é—®ä»¤ç‰Œ
    if (!"admin123".equals(accessToken)) {
        throw new RuntimeException("è®¿é—®ä»¤ç‰Œæ— æ•ˆ");
    }
    
    // åˆ é™¤å•†å“
    int deletedCount = productMapper.deleteByMerchantId(merchantId);
    
    ClearResult result = new ClearResult();
    result.setDeletedCount(deletedCount);
    
    return result;
}
```

---

## ğŸ’¡ ä¸ºä»€ä¹ˆä½¿ç”¨ merchantId = 1

åœ¨å½“å‰ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰å•†å“éƒ½å±äºé»˜è®¤å•†å®¶ï¼ˆID = 1ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„è®¾è®¡ï¼Œé€‚ç”¨äºå•å•†å®¶åœºæ™¯ã€‚

å¦‚æœå°†æ¥éœ€è¦æ”¯æŒå¤šå•†å®¶ï¼Œå¯ä»¥ï¼š

1. åœ¨ç”¨æˆ·ç™»å½•æ—¶ä¿å­˜å•†å®¶IDåˆ° localStorage æˆ– Vuex
2. ä»å­˜å‚¨ä¸­è¯»å–å•†å®¶IDå¹¶ä¼ é€’ç»™æ¥å£
3. åç«¯æ ¹æ®ç”¨æˆ·æƒé™éªŒè¯å•†å®¶ID

---

## âœ… éªŒè¯æ¸…å•

- [x] å‰ç«¯è¯·æ±‚åŒ…å« `merchantId` å‚æ•°
- [x] å‰ç«¯è¯·æ±‚åŒ…å« `accessToken` å‚æ•°
- [x] åç«¯æ­£ç¡®æ¥æ”¶ä¸¤ä¸ªå‚æ•°
- [x] åç«¯éªŒè¯è®¿é—®ä»¤ç‰Œ
- [x] åç«¯åˆ é™¤æŒ‡å®šå•†å®¶çš„æ‰€æœ‰å•†å“
- [x] å‰ç«¯æ˜¾ç¤ºæˆåŠŸæç¤º
- [x] å‰ç«¯åˆ·æ–°å•†å“åˆ—è¡¨

---

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤åï¼š
- âœ… ç‚¹å‡»"æ¸…ç©ºå•†å“"ä¸å†è¿”å›500é”™è¯¯
- âœ… è¾“å…¥æ­£ç¡®çš„è®¿é—®ä»¤ç‰Œåå¯ä»¥æˆåŠŸæ¸…ç©ºå•†å“
- âœ… æ˜¾ç¤º"æˆåŠŸæ¸…ç©º X ä¸ªå•†å“"æç¤º
- âœ… å•†å“åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°ä¸ºç©º

---

**çŠ¶æ€**: âœ… å·²ä¿®å¤
