# 后端启动错误修复指南

## 问题概述
后端启动时出现两个错误：
1. ❌ MySQL连接错误：`Public Key Retrieval is not allowed`
2. ⚠️ MinIO连接失败：`Failed to connect to localhost:9000`

---

## 错误 1: MySQL连接问题 ✅ 已修复

### 错误信息
```
java.sql.SQLNonTransientConnectionException: Public Key Retrieval is not allowed
```

### 原因
MySQL 8.0+ 使用 `caching_sha2_password` 认证插件，需要允许公钥检索。

### 解决方案
已在 `application.yml` 中添加 `allowPublicKeyRetrieval=true` 参数：

```yaml
datasource:
  url: jdbc:mysql://localhost:3306/meituan?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
```

### 状态
✅ 已修复 - 重启后端即可

---

## 错误 2: MinIO连接失败 ⚠️ 需要启动MinIO

### 错误信息
```
java.net.ConnectException: Failed to connect to localhost/[0:0:0:0:0:0:0:1]:9000
```

### 原因
MinIO服务未启动。

### 解决方案

#### 方案1：启动MinIO（推荐）
如果您需要使用图片上传功能，请启动MinIO：

```bash
# 使用启动脚本
start-minio.bat

# 或者手动启动
minio.exe server E:\minio-data --console-address ":9001"
```

MinIO启动后：
- API端口：http://localhost:9000
- 控制台：http://localhost:9001
- 默认账号：minioadmin / minioadmin

#### 方案2：暂时禁用MinIO（如果不需要图片功能）
如果暂时不需要图片上传功能，可以注释掉MinIO初始化：

**文件：** `meituan-backend/src/main/java/com/meituan/product/config/MinioInitializer.java`

```java
@Component
@RequiredArgsConstructor
// @Order(2)  // 注释掉这行
public class MinioInitializer implements CommandLineRunner {
    
    private final MinioService minioService;
    
    @Override
    public void run(String... args) {
        // 暂时注释掉MinIO初始化
        // log.info("开始初始化MinIO存储桶...");
        // minioService.initBucket();
        // log.info("MinIO存储桶初始化完成");
    }
}
```

### 状态
⚠️ 需要操作 - 选择方案1或方案2

---

## 快速修复步骤

### 步骤1：重启后端（修复MySQL问题）
1. 停止当前运行的后端
2. 重新启动后端
3. 检查是否还有MySQL连接错误

### 步骤2：处理MinIO（可选）

**如果需要图片上传功能：**
```bash
# 启动MinIO
start-minio.bat
```

**如果暂时不需要：**
- MinIO错误不会影响其他功能
- 系统会记录错误但继续运行
- 只有图片上传功能会受影响

---

## 验证修复

### 1. 检查后端日志
启动后应该看到：
```
Started ProductUploadApplication in X.XXX seconds
```

### 2. 检查数据库连接
日志中应该看到：
```
HikariPool-1 - Starting...
HikariPool-1 - Start completed.
```

### 3. 检查MinIO（如果启动了）
日志中应该看到：
```
开始初始化MinIO存储桶...
MinIO存储桶初始化完成
```

### 4. 测试API
访问：http://localhost:8080/api/products/stats

应该返回JSON数据而不是错误。

---

## 常见问题

### Q1: 重启后还是MySQL连接错误？
**A:** 检查以下几点：
1. MySQL服务是否正在运行
2. 数据库 `meituan` 是否存在
3. 用户名密码是否正确（默认：root/root）
4. 端口是否正确（默认：3306）

### Q2: MinIO启动失败？
**A:** 检查：
1. 端口9000和9001是否被占用
2. 数据目录是否存在（E:\minio-data）
3. 是否有足够的磁盘空间

### Q3: 不启动MinIO会影响什么功能？
**A:** 只影响图片上传功能，其他功能正常：
- ✅ 商品导入
- ✅ 模板生成
- ✅ 批量上传
- ✅ 历史文件下载
- ❌ 图片上传（需要MinIO）

---

## 下一步操作

1. ✅ **立即操作**：重启后端（MySQL问题已修复）
2. ⚠️ **可选操作**：启动MinIO（如果需要图片功能）
3. ✅ **验证操作**：访问前端页面测试功能

---

## 相关文件

- `meituan-backend/src/main/resources/application.yml` - 数据库配置（已修复）
- `start-minio.bat` - MinIO启动脚本
- `MINIO_SETUP_COMPLETE.md` - MinIO完整配置文档

---

## 总结

- ✅ MySQL连接问题已修复，重启后端即可
- ⚠️ MinIO是可选的，只在需要图片上传时启动
- 🎯 核心功能（导入、生成模板、历史文件）不依赖MinIO

**建议：先重启后端测试核心功能，如果需要图片上传再启动MinIO。**
