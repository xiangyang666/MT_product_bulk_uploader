# 手动测试指南 - 系统设置 JSON 修复

## 测试前准备

### 1. 部署更新后的代码

```bash
# 打包
cd meituan-backend
mvn clean package -Dmaven.test.skip=true

# 上传到服务器
scp target/app.jar root@106.55.102.48:/opt/meituan/

# 重启服务
ssh root@106.55.102.48
cd /opt/meituan/
ps aux | grep app.jar
kill -9 <进程ID>
nohup java -jar app.jar > app.log 2>&1 &
```

### 2. 确认服务启动成功

```bash
# 查看日志
tail -f /opt/meituan/app.log

# 等待看到类似信息：
# Started ProductUploadApplication in X.XXX seconds
```

---

## 测试场景

### 场景 1：基本保存功能

**目的：** 验证系统设置页面可以正常保存配置

**步骤：**
1. 登录系统（使用 admin/admin123）
2. 导航到"系统设置"页面
3. 修改任意配置项（如商家名称）
4. 点击"保存"按钮
5. 观察是否出现成功提示

**预期结果：**
- ✅ 保存成功，显示"配置更新成功"
- ✅ 页面不刷新，数据保持
- ✅ 没有出现 JSON 错误

**失败标志：**
- ❌ 出现 500 错误
- ❌ 出现 "Invalid JSON text" 错误
- ❌ 保存按钮无响应

---

### 场景 2：空配置保存

**目的：** 验证空配置可以正常保存

**步骤：**
1. 打开系统设置页面
2. 清空所有可选字段（保留必填字段）
3. 点击"保存"
4. 刷新页面，验证数据已保存

**预期结果：**
- ✅ 保存成功
- ✅ 刷新后数据正确显示
- ✅ template_config 自动设置为 "{}"

---

### 场景 3：重置为默认值

**目的：** 验证重置功能正常工作

**步骤：**
1. 打开系统设置页面
2. 修改一些配置项
3. 点击"重置为默认值"按钮
4. 确认重置操作
5. 验证配置恢复为默认值

**预期结果：**
- ✅ 重置成功
- ✅ 所有字段恢复默认值
- ✅ template_config 为 "{}"

---

### 场景 4：多次保存

**目的：** 验证连续保存操作稳定性

**步骤：**
1. 打开系统设置页面
2. 修改配置并保存（第 1 次）
3. 再次修改配置并保存（第 2 次）
4. 重复 3-5 次
5. 验证每次都成功

**预期结果：**
- ✅ 每次保存都成功
- ✅ 没有累积错误
- ✅ 响应时间稳定

---

### 场景 5：并发保存（可选）

**目的：** 验证并发场景下的稳定性

**步骤：**
1. 在两个浏览器标签页打开系统设置
2. 在两个标签页同时修改配置
3. 几乎同时点击保存
4. 验证最后保存的数据生效

**预期结果：**
- ✅ 两次保存都成功（或一次成功）
- ✅ 没有数据损坏
- ✅ 最后保存的数据生效

---

## 日志验证

### 1. 查看应用日志

```bash
ssh root@106.55.102.48
tail -f /opt/meituan/app.log
```

### 2. 关键日志消息

**成功保存：**
```
更新商家配置成功，商家ID：1，耗时：XXms
```

**JSON 清理（如果有旧数据）：**
```
检测到空的 template_config，已自动设置为空 JSON 对象，商家ID：1
```

**错误恢复（如果触发）：**
```
检测到 JSON 相关错误，尝试使用默认 JSON 值重试，商家ID：1
使用默认 JSON 更新商家配置成功，商家ID：1
```

### 3. 不应该出现的错误

❌ **这些错误不应该再出现：**
```
Invalid JSON text: "The document is empty."
Data truncation: Invalid JSON text
```

---

## 数据库验证

### 1. 检查 template_config 值

```sql
USE meituan_product;

-- 查看所有商家配置的 template_config
SELECT 
    id,
    merchant_id,
    merchant_name,
    template_config,
    CASE 
        WHEN template_config IS NULL THEN '❌ NULL'
        WHEN template_config = '' THEN '❌ 空字符串'
        WHEN template_config = '{}' THEN '✅ 空 JSON'
        ELSE '✅ 有数据'
    END AS status
FROM t_merchant_config
ORDER BY id;
```

**预期结果：**
- 所有记录的 template_config 都应该是有效的 JSON
- 没有 NULL 值
- 没有空字符串
- 大部分应该是 "{}" 或有效的 JSON 对象

---

## API 测试（可选）

### 使用 curl 测试

```bash
# 1. 登录获取 Token
TOKEN=$(curl -s -X POST http://106.55.102.48:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | jq -r '.data.token')

echo "Token: $TOKEN"

# 2. 获取当前配置
curl -X GET "http://106.55.102.48:8080/api/settings?merchantId=1" \
  -H "Authorization: Bearer $TOKEN" \
  | jq '.'

# 3. 更新配置
curl -X PUT "http://106.55.102.48:8080/api/settings" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "merchantId": 1,
    "merchantName": "测试商家",
    "meituanAppKey": "test-key-123",
    "meituanAppSecret": "test-secret-456"
  }' \
  | jq '.'

# 4. 验证更新成功
curl -X GET "http://106.55.102.48:8080/api/settings?merchantId=1" \
  -H "Authorization: Bearer $TOKEN" \
  | jq '.data.templateConfig'

# 应该返回: "{}"
```

---

## 测试检查清单

完成所有测试后，请确认：

### 功能测试
- [ ] ✅ 场景 1：基本保存功能正常
- [ ] ✅ 场景 2：空配置可以保存
- [ ] ✅ 场景 3：重置功能正常
- [ ] ✅ 场景 4：多次保存稳定
- [ ] ✅ 场景 5：并发保存正常（可选）

### 日志验证
- [ ] ✅ 成功日志正常输出
- [ ] ✅ 没有 JSON 错误
- [ ] ✅ 如有清理日志，说明自动处理生效

### 数据库验证
- [ ] ✅ 所有 template_config 都是有效 JSON
- [ ] ✅ 没有 NULL 或空字符串
- [ ] ✅ 数据完整性良好

### 用户体验
- [ ] ✅ 页面响应快速
- [ ] ✅ 错误提示清晰（如果有）
- [ ] ✅ 操作流畅，无卡顿

---

## 问题排查

### 如果保存仍然失败

1. **检查日志：**
   ```bash
   tail -100 /opt/meituan/app.log | grep -i error
   ```

2. **检查数据库连接：**
   ```bash
   mysql -h 106.55.102.48 -u root -p meituan_product
   ```

3. **验证代码已部署：**
   ```bash
   # 检查 JAR 文件修改时间
   ls -lh /opt/meituan/app.jar
   
   # 应该是最新的时间戳
   ```

4. **重启服务：**
   ```bash
   cd /opt/meituan/
   ps aux | grep app.jar
   kill -9 <进程ID>
   nohup java -jar app.jar > app.log 2>&1 &
   ```

---

## 测试完成

如果所有测试都通过，说明 JSON 错误已成功修复！

**下一步：**
1. 通知用户可以正常使用系统设置功能
2. 监控生产环境日志，确保稳定运行
3. 如有问题，查看日志并联系开发团队

---

**测试人员：** _____________  
**测试日期：** _____________  
**测试结果：** ✅ 通过 / ❌ 失败  
**备注：** _____________
