# 生成模板 500 错误排查

## 🐛 错误信息

```
POST http://localhost:5173/api/products/generate-template 500 (Internal Server Error)
```

## 🔍 可能的原因

### 1. 后端未重启
- 修改了代码后没有重启后端
- 旧代码还在运行

### 2. 数据库中没有商品数据
- 选择的商品ID在数据库中不存在
- 商品被逻辑删除（deleted=1）

### 3. TemplateConfig 加载失败
- template-config.json 文件读取失败
- JSON 格式错误

### 4. 商品数据不完整
- 必填字段为空
- 数据格式不正确

---

## 🔧 解决方案

### 方案 1：检查后端日志（最重要）

#### 1.1 查看后端控制台

在后端运行的命令行窗口中，查找错误信息：

```
查找关键词：
- "生成模板失败"
- "ERROR"
- "Exception"
- "NullPointerException"
```

#### 1.2 常见错误信息

**错误 1：NullPointerException**
```
java.lang.NullPointerException: Cannot invoke "getTemplateName()" 
because "this.templateConfig" is null
```
**原因**：TemplateConfig 没有正确注入  
**解决**：重启后端

**错误 2：未找到商品**
```
java.lang.IllegalArgumentException: 未找到指定的商品数据
```
**原因**：选择的商品ID不存在  
**解决**：检查数据库，重新导入商品

**错误 3：文件读取失败**
```
java.io.IOException: template-config.json not found
```
**原因**：配置文件缺失  
**解决**：检查 resources 目录

---

### 方案 2：重启后端服务

#### 2.1 停止后端

```
在后端命令行窗口按 Ctrl + C
```

#### 2.2 重新启动

```bash
cd meituan-backend
mvn spring-boot:run
```

或双击 `start-backend.bat`

#### 2.3 等待启动完成

看到以下信息说明启动成功：

```
Started MeituanProductApplication in X.XXX seconds
```

---

### 方案 3：检查数据库

#### 3.1 查看商品数据

```sql
USE meituan_product;

-- 查看所有商品
SELECT id, product_name, category_id, price, deleted
FROM t_product
WHERE deleted = 0
ORDER BY id;

-- 统计商品数量
SELECT COUNT(*) AS total FROM t_product WHERE deleted = 0;
```

#### 3.2 如果没有商品

```
1. 进入"批量导入"页面
2. 上传商品 Excel 文件
3. 导入成功后再试
```

---

### 方案 4：检查前端请求

#### 4.1 打开浏览器开发者工具

```
按 F12 → Network 标签页
```

#### 4.2 查看请求详情

1. **点击"生成模板"按钮**
2. **找到 generate-template 请求**
3. **查看 Request Payload**

应该看到：

```json
{
  "productIds": [1, 2, 3, 4, 5]
}
```

#### 4.3 查看响应

点击 Response 标签页，查看错误信息

---

### 方案 5：测试 API

#### 5.1 使用 Postman 或 curl 测试

```bash
curl -X POST http://localhost:8080/api/products/generate-template \
  -H "Content-Type: application/json" \
  -d '{"productIds": [1, 2, 3]}'
```

#### 5.2 预期结果

- **成功**：返回 Excel 文件（二进制数据）
- **失败**：返回错误信息

---

## 🎯 快速诊断步骤

### 步骤 1：检查后端是否运行

```bash
# 访问健康检查接口
curl http://localhost:8080/actuator/health

# 或在浏览器打开
http://localhost:8080/actuator/health
```

**预期结果**：
```json
{"status":"UP"}
```

---

### 步骤 2：检查商品数据

```sql
-- 快速检查
SELECT COUNT(*) FROM t_product WHERE deleted = 0;
```

**预期结果**：大于 0

---

### 步骤 3：查看后端日志

```
在后端命令行窗口查找最新的错误信息
```

---

### 步骤 4：重启后端

```
Ctrl + C → 重新运行 start-backend.bat
```

---

### 步骤 5：重试

```
刷新前端页面 → 选择商品 → 生成模板
```

---

## 📋 完整排查清单

- [ ] 1. 后端是否正在运行？
- [ ] 2. 后端启动时有没有错误？
- [ ] 3. 数据库中有商品数据吗？
- [ ] 4. 选择的商品ID是否存在？
- [ ] 5. 后端日志中有什么错误信息？
- [ ] 6. template-config.json 文件存在吗？
- [ ] 7. 前端请求的数据格式正确吗？
- [ ] 8. 尝试重启后端了吗？

---

## 🔍 详细日志分析

### 查看完整错误堆栈

在后端日志中查找：

```
ERROR c.m.product.service.ExcelService - 生成模板失败
java.lang.NullPointerException: ...
    at com.meituan.product.service.ExcelService.generateMeituanTemplate(...)
    at com.meituan.product.service.ProductService.generateMeituanTemplate(...)
    at com.meituan.product.controller.ProductController.generateTemplate(...)
```

### 常见错误及解决方法

#### 错误 1：TemplateConfig 为 null

**日志**：
```
NullPointerException: Cannot invoke "getTemplateName()" 
because "this.templateConfig" is null
```

**原因**：
- Spring 依赖注入失败
- @Component 注解缺失
- 配置文件加载失败

**解决**：
1. 检查 TemplateConfig 类是否有 @Component 注解
2. 检查 template-config.json 是否在 resources 目录
3. 重启后端

---

#### 错误 2：商品数据为空

**日志**：
```
IllegalArgumentException: 未找到指定的商品数据
```

**原因**：
- 数据库中没有对应的商品
- 商品被逻辑删除

**解决**：
```sql
-- 检查商品
SELECT * FROM t_product WHERE id IN (1,2,3) AND deleted = 0;

-- 如果为空，重新导入商品
```

---

#### 错误 3：文件写入失败

**日志**：
```
IOException: 生成模板失败
```

**原因**：
- 磁盘空间不足
- 权限问题
- POI 库版本问题

**解决**：
1. 检查磁盘空间
2. 检查 pom.xml 中的 POI 依赖版本
3. 重启后端

---

## 💡 临时解决方案

如果以上方法都不行，可以尝试：

### 方案 A：使用测试数据

```sql
-- 插入测试商品
INSERT INTO t_product (merchant_id, product_name, category_id, price, stock, status)
VALUES 
(1, '测试商品1', '1234567890', 99.00, 100, 0),
(1, '测试商品2', '1234567890', 88.00, 50, 0),
(1, '测试商品3', '1234567890', 77.00, 200, 0);

-- 查看插入的商品ID
SELECT id, product_name FROM t_product ORDER BY id DESC LIMIT 3;
```

然后选择这些商品生成模板。

---

### 方案 B：简化配置

临时修改 `ExcelService.java`，添加默认配置：

```java
// 如果 templateConfig 为 null，使用默认配置
if (templateConfig == null || templateConfig.getColumns() == null) {
    log.warn("TemplateConfig 未加载，使用默认配置");
    // 使用硬编码的默认列配置
}
```

---

## 🎯 最可能的原因

根据经验，最常见的原因是：

1. **后端没有重启**（80%）
   - 修改代码后必须重启
   - 解决：Ctrl + C → 重新启动

2. **数据库中没有商品**（15%）
   - 还没有导入商品数据
   - 解决：先导入商品

3. **配置文件问题**（5%）
   - template-config.json 缺失或格式错误
   - 解决：检查文件

---

## 📝 下一步操作

### 立即执行

1. **查看后端日志**
   - 找到具体的错误信息
   - 截图或复制错误堆栈

2. **重启后端**
   ```
   Ctrl + C → start-backend.bat
   ```

3. **检查数据库**
   ```sql
   SELECT COUNT(*) FROM t_product WHERE deleted = 0;
   ```

4. **重试生成模板**
   - 刷新前端
   - 选择商品
   - 点击生成模板

---

## 🆘 如果还是不行

请提供以下信息：

1. **后端日志中的完整错误信息**
2. **数据库中的商品数量**
3. **前端 Network 标签中的请求详情**
4. **后端启动时的日志**

---

**文档更新日期**：2026-02-09  
**状态**：故障排查指南  
**优先级**：🔴 高
