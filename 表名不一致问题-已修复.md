# 表名不一致问题 - 已修复 ✅

## 🐛 问题描述

首页报错：
```
Table 'meituan_product.product' doesn't exist
```

完整错误信息：
```
### Error querying database.  Cause: java.sql.SQLSyntaxErrorException: Table 'meituan_product.product' doesn't exist
### The error may exist in file [.../ProductMapper.xml]
### SQL: SELECT * FROM product WHERE merchant_id = ? ORDER BY created_at DESC
```

---

## 🔍 根本原因

**代码中有两个地方使用了不同的表名：**

### 1. Entity类（正确）
```java
@TableName("t_product")  // ✅ 使用 t_product
public class Product {
    // ...
}
```

MyBatis-Plus 自动生成的SQL会使用 `t_product`

### 2. ProductMapper.xml（错误）
```xml
<!-- ❌ 使用了 product -->
<select id="selectByMerchantId">
    SELECT * FROM product
    WHERE merchant_id = #{merchantId}
    ORDER BY created_at DESC
</select>
```

手写的SQL使用了 `product`，但数据库中的表名是 `t_product`

---

## ✅ 解决方案

### 已修复的文件

**meituan-backend/src/main/resources/mapper/ProductMapper.xml**

### 修改内容

#### 修改前：
```xml
<!-- 批量插入商品 -->
<insert id="batchInsert">
    INSERT INTO product (...)  ❌
    VALUES ...
</insert>

<!-- 根据商家ID查询商品列表 -->
<select id="selectByMerchantId">
    SELECT * FROM product  ❌
    WHERE merchant_id = #{merchantId}
    ORDER BY created_at DESC
</select>

<!-- 根据商家ID删除商品 -->
<delete id="deleteByMerchantId">
    DELETE FROM product  ❌
    WHERE merchant_id = #{merchantId}
</delete>
```

#### 修改后：
```xml
<!-- 批量插入商品 -->
<insert id="batchInsert">
    INSERT INTO t_product (...)  ✅
    VALUES ...
</insert>

<!-- 根据商家ID查询商品列表 -->
<select id="selectByMerchantId">
    SELECT * FROM t_product  ✅
    WHERE merchant_id = #{merchantId} AND deleted = 0  ✅ 添加逻辑删除过滤
    ORDER BY created_time DESC  ✅ 修正字段名
</select>

<!-- 根据商家ID删除商品 -->
<delete id="deleteByMerchantId">
    DELETE FROM t_product  ✅
    WHERE merchant_id = #{merchantId}
</delete>
```

### 额外修复

1. **添加逻辑删除过滤**：`AND deleted = 0`
2. **修正字段名**：`created_at` → `created_time`（与Entity类一致）

---

## 🚀 下一步操作

### 1. 重启后端服务

**停止后端：**
- 在后端命令行窗口按 `Ctrl + C`

**重新启动：**
```bash
start-backend.bat
```

或者：
```bash
cd meituan-backend
mvn spring-boot:run
```

**等待启动完成：**
看到以下信息说明成功：
```
Started MeituanProductApplication in X.XXX seconds
```

### 2. 执行数据库恢复脚本

**在MySQL客户端执行：**
```sql
source 重建商品表.sql
```

这会：
- ✅ 创建 `t_product` 表
- ✅ 插入20个测试商品

### 3. 刷新前端并测试

1. **刷新浏览器**（按F5）
2. **查看首页** - 应该能看到统计数据
3. **进入"批量上传"** - 应该能看到商品列表
4. **生成模板** - 应该能成功下载

---

## 📋 完整操作清单

- [x] 1. 修复 ProductMapper.xml 中的表名
- [ ] 2. 重启后端服务
- [ ] 3. 执行 `重建商品表.sql` 恢复数据
- [ ] 4. 刷新前端页面
- [ ] 5. 测试首页统计功能
- [ ] 6. 测试批量上传功能
- [ ] 7. 测试生成模板功能

---

## 🔍 验证修复成功

### 1. 检查后端启动日志

应该没有错误信息，看到：
```
Started MeituanProductApplication in X.XXX seconds
成功加载模板配置：美团商品上传模板
```

### 2. 检查数据库

```sql
USE meituan_product;

-- 表应该存在
SHOW TABLES LIKE 't_product';

-- 应该有20条数据
SELECT COUNT(*) FROM t_product WHERE deleted = 0;
```

### 3. 测试前端

**首页：**
- 应该显示统计数据（总商品数、待上传、已上传等）
- 不应该有500错误

**批量上传页面：**
- 应该显示商品列表
- 可以勾选商品
- 可以生成模板并下载

---

## 💡 为什么会出现这个问题？

### 表名命名不一致

项目中同时使用了两种方式操作数据库：

1. **MyBatis-Plus（自动）**
   - 通过 `@TableName("t_product")` 注解指定表名
   - 自动生成的SQL使用 `t_product`
   - 例如：`selectById`, `selectBatchIds`, `updateById` 等

2. **MyBatis XML（手动）**
   - 在 ProductMapper.xml 中手写SQL
   - 需要手动指定表名
   - 如果写错了表名，就会报错

### 正确的做法

**保持一致性：**
- Entity类的 `@TableName` 注解
- XML中的表名
- 数据库中的实际表名

**都应该使用同一个表名：`t_product`**

---

## 🛡️ 预防措施

### 1. 统一表名规范

在项目中统一使用 `t_` 前缀：
- `t_product` - 商品表
- `t_merchant` - 商家表
- `t_template` - 模板表
- `t_user` - 用户表

### 2. 代码审查

修改XML文件时，确保：
- 表名与Entity类的 `@TableName` 一致
- 字段名与Entity类的属性名一致（驼峰转下划线）
- 添加必要的过滤条件（如 `deleted = 0`）

### 3. 单元测试

为Mapper方法编写单元测试：
```java
@Test
public void testSelectByMerchantId() {
    List<Product> products = productMapper.selectByMerchantId(1L);
    assertNotNull(products);
}
```

---

## 📝 相关文件

### 已修复的文件：
- ✅ `meituan-backend/src/main/resources/mapper/ProductMapper.xml`

### 需要执行的脚本：
- `重建商品表.sql` - 恢复表结构和数据

### 参考文档：
- `快速恢复商品表.md` - 数据恢复指南
- `商品数据不存在-解决方案.md` - 商品数据问题解决方案

---

## 🎯 总结

### 问题
- ProductMapper.xml 使用了错误的表名 `product`
- 实际表名是 `t_product`

### 解决
- 修改 ProductMapper.xml 中所有的 `product` → `t_product`
- 添加逻辑删除过滤 `AND deleted = 0`
- 修正字段名 `created_at` → `created_time`

### 下一步
1. 重启后端服务
2. 执行数据库恢复脚本
3. 刷新前端测试

---

**修复日期**: 2026-02-09  
**修复文件**: ProductMapper.xml  
**问题类型**: 表名不一致  
**状态**: ✅ 已修复
