# JWT è®¤è¯ç³»ç»Ÿ - å®ç°æ€»ç»“

## ğŸ“Œ ä»»åŠ¡å®ŒæˆçŠ¶æ€

âœ… **å·²å®Œæˆ** - JWT è®¤è¯ç³»ç»Ÿå·²å®Œæ•´å®ç°ï¼Œå¯ä»¥ç«‹å³éƒ¨ç½²

---

## ğŸ¯ å®ç°ç›®æ ‡

å®ç°å®Œæ•´çš„ JWT Token è®¤è¯æœºåˆ¶ï¼Œç¡®ä¿ï¼š
- âœ… åªæœ‰ç™»å½•/æ³¨å†Œæ¥å£å…¬å¼€è®¿é—®
- âœ… æ‰€æœ‰å…¶ä»– API æ¥å£éƒ½éœ€è¦è®¤è¯
- âœ… Token è‡ªåŠ¨ç”Ÿæˆã€éªŒè¯å’Œç®¡ç†
- âœ… å‰ç«¯è‡ªåŠ¨æºå¸¦ Token è®¿é—®æ¥å£

---

## ğŸ”¨ æŠ€æœ¯å®ç°

### 1. JWT å·¥å…·ç±» (`JwtUtil.java`)

**åŠŸèƒ½ï¼š**
- ç”Ÿæˆ JWT Tokenï¼ˆåŒ…å« userId, username, roleï¼‰
- éªŒè¯ Token æœ‰æ•ˆæ€§
- è§£æ Token è·å–ç”¨æˆ·ä¿¡æ¯

**æŠ€æœ¯ç»†èŠ‚ï¼š**
- åº“ï¼šJJWT 0.12.3
- ç®—æ³•ï¼šHMAC-SHA256
- æœ‰æ•ˆæœŸï¼š7å¤©
- å¯†é’¥ï¼š64å­—ç¬¦å¼ºå¯†é’¥

**æ ¸å¿ƒæ–¹æ³•ï¼š**
```java
generateToken(userId, username, role)  // ç”Ÿæˆ Token
validateToken(token)                   // éªŒè¯ Token
parseToken(token)                      // è§£æ Token
getUsernameFromToken(token)            // è·å–ç”¨æˆ·å
getUserIdFromToken(token)              // è·å–ç”¨æˆ·ID
getRoleFromToken(token)                // è·å–è§’è‰²
```

---

### 2. JWT è®¤è¯è¿‡æ»¤å™¨ (`JwtAuthenticationFilter.java`)

**åŠŸèƒ½ï¼š**
- æ‹¦æˆªæ‰€æœ‰ HTTP è¯·æ±‚
- ä»è¯·æ±‚å¤´æå– `Authorization: Bearer <token>`
- éªŒè¯ Token å¹¶è®¾ç½® Spring Security ä¸Šä¸‹æ–‡

**å·¥ä½œæµç¨‹ï¼š**
```
è¯·æ±‚åˆ°è¾¾
  â†“
æå– Authorization å¤´
  â†“
éªŒè¯ Token æ ¼å¼å’Œæœ‰æ•ˆæ€§
  â†“
è§£æç”¨æˆ·ä¿¡æ¯
  â†“
è®¾ç½® SecurityContext
  â†“
ç»§ç»­å¤„ç†è¯·æ±‚
```

---

### 3. å®‰å…¨é…ç½® (`SecurityConfig.java`)

**åŠŸèƒ½ï¼š**
- é…ç½®å“ªäº›æ¥å£éœ€è¦è®¤è¯
- é›†æˆ JWT è¿‡æ»¤å™¨
- é…ç½®æ— çŠ¶æ€ä¼šè¯ç®¡ç†

**è®¿é—®è§„åˆ™ï¼š**
```java
/api/auth/**     â†’ å…è®¸åŒ¿åè®¿é—®ï¼ˆç™»å½•ã€æ³¨å†Œï¼‰
/api/**          â†’ éœ€è¦è®¤è¯
å…¶ä»–             â†’ éœ€è¦è®¤è¯
```

**ç‰¹æ€§ï¼š**
- âœ… CSRF å·²ç¦ç”¨ï¼ˆé€‚åˆ APIï¼‰
- âœ… æ— çŠ¶æ€ä¼šè¯ï¼ˆStatelessï¼‰
- âœ… CORS å·²å¯ç”¨
- âœ… JWT è¿‡æ»¤å™¨å·²é›†æˆ

---

### 4. è®¤è¯æ§åˆ¶å™¨ (`AuthController.java`)

**æ¥å£åˆ—è¡¨ï¼š**

| æ¥å£ | æ–¹æ³• | è®¤è¯ | è¯´æ˜ |
|------|------|------|------|
| `/api/auth/login` | POST | âŒ | ç”¨æˆ·ç™»å½•ï¼Œè¿”å› Token |
| `/api/auth/register` | POST | âŒ | ç”¨æˆ·æ³¨å†Œ |
| `/api/auth/logout` | POST | âœ… | é€€å‡ºç™»å½• |
| `/api/auth/userinfo` | GET | âœ… | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ |

**ç™»å½•å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOjEsInVzZXJuYW1lIjoiYWRtaW4iLCJyb2xlIjoiU1VQRVJfQURNSU4ifQ...",
    "userInfo": {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "role": "SUPER_ADMIN"
    }
  }
}
```

---

### 5. å‰ç«¯é›†æˆ (`src/api/index.js`)

**Axios è¯·æ±‚æ‹¦æˆªå™¨ï¼š**
```javascript
request.interceptors.request.use(config => {
  const token = localStorage.getItem('token')
  if (token) {
    config.headers['Authorization'] = `Bearer ${token}`
  }
  return config
})
```

**Axios å“åº”æ‹¦æˆªå™¨ï¼š**
```javascript
request.interceptors.response.use(
  response => { /* å¤„ç†æˆåŠŸå“åº” */ },
  error => {
    if (error.response.status === 401) {
      ElMessage.error('æœªæˆæƒè®¿é—®ï¼Œè¯·é‡æ–°ç™»å½•')
    }
    return Promise.reject(error)
  }
)
```

**Token ç®¡ç†ï¼š**
- ç™»å½•æˆåŠŸï¼š`localStorage.setItem('token', token)`
- é€€å‡ºç™»å½•ï¼š`localStorage.removeItem('token')`
- è‡ªåŠ¨æºå¸¦ï¼šæ¯ä¸ªè¯·æ±‚è‡ªåŠ¨æ·»åŠ  Authorization å¤´

---

## ğŸ“¦ ä¾èµ–é…ç½® (`pom.xml`)

å·²æ·»åŠ  JJWT ä¾èµ–ï¼š
```xml
<!-- JWT -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.12.3</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-impl</artifactId>
    <version>0.12.3</version>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-jackson</artifactId>
    <version>0.12.3</version>
    <scope>runtime</scope>
</dependency>
```

---

## ğŸ§ª æµ‹è¯•å·¥å…· (`test-api-auth.html`)

**åŠŸèƒ½ï¼š**
- å¯è§†åŒ–æµ‹è¯• JWT è®¤è¯æµç¨‹
- æ˜¾ç¤º Token çŠ¶æ€å’Œå†…å®¹
- æµ‹è¯•å„ç§è®¤è¯åœºæ™¯

**æµ‹è¯•åœºæ™¯ï¼š**
1. âœ… ç”¨æˆ·ç™»å½• - è·å– Token
2. âœ… è·å–ç”¨æˆ·ä¿¡æ¯ - éªŒè¯ Token æœ‰æ•ˆæ€§
3. âœ… è·å–å•†å“ç»Ÿè®¡ - æµ‹è¯•ä¸šåŠ¡æ¥å£è®¤è¯
4. âœ… é€€å‡ºç™»å½• - æ¸…é™¤ Token
5. âœ… æ—  Token è®¿é—® - éªŒè¯æ‹¦æˆªæœºåˆ¶

---

## ğŸ” å®‰å…¨ç‰¹æ€§

### å·²å®ç°çš„å®‰å…¨æªæ–½

1. **Token ç­¾åéªŒè¯**
   - ä½¿ç”¨ HMAC-SHA256 ç®—æ³•
   - 64å­—ç¬¦å¼ºå¯†é’¥
   - é˜²æ­¢ Token ç¯¡æ”¹

2. **Token è¿‡æœŸæœºåˆ¶**
   - 7å¤©è‡ªåŠ¨è¿‡æœŸ
   - è¿‡æœŸåéœ€è¦é‡æ–°ç™»å½•

3. **æ— çŠ¶æ€è®¤è¯**
   - æœåŠ¡å™¨ä¸å­˜å‚¨ Session
   - å®Œå…¨åŸºäº Token
   - æ˜“äºæ°´å¹³æ‰©å±•

4. **å¯†ç åŠ å¯†**
   - BCrypt åŠ å¯†ï¼ˆå¼ºåº¦ 10ï¼‰
   - ä¸å¯é€†åŠ å¯†
   - é˜²æ­¢å¯†ç æ³„éœ²

5. **CORS ä¿æŠ¤**
   - é…ç½®å…è®¸çš„æ¥æº
   - é˜²æ­¢è·¨åŸŸæ”»å‡»

---

## ğŸ“Š è®¤è¯æµç¨‹

### å®Œæ•´è®¤è¯æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç™»å½•    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/auth/login    â”‚
â”‚ {username, password}    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éªŒè¯ç”¨æˆ·åå’Œå¯†ç          â”‚
â”‚ (BCrypt å¯†ç éªŒè¯)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”Ÿæˆ JWT Token          â”‚
â”‚ åŒ…å«: userId, username, â”‚
â”‚       role, è¿‡æœŸæ—¶é—´     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å› Token ç»™å‰ç«¯       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ä¿å­˜åˆ° localStorage â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç»­è¯·æ±‚è‡ªåŠ¨æ·»åŠ         â”‚
â”‚ Authorization: Bearer   â”‚
â”‚ <token>                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JwtAuthenticationFilter â”‚
â”‚ æ‹¦æˆªå¹¶éªŒè¯ Token        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éªŒè¯ç­¾åå’Œæœ‰æ•ˆæœŸ        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§£æç”¨æˆ·ä¿¡æ¯            â”‚
â”‚ è®¾ç½® SecurityContext    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…è®¸è®¿é—®å—ä¿æŠ¤æ¥å£      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶ï¼ˆå·²ä¿®æ”¹/åˆ›å»ºï¼‰

| æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| `meituan-backend/pom.xml` | âœ… å·²ä¿®æ”¹ | æ·»åŠ  JWT ä¾èµ– |
| `meituan-backend/src/main/java/com/meituan/product/util/JwtUtil.java` | âœ… å·²åˆ›å»º | JWT å·¥å…·ç±» |
| `meituan-backend/src/main/java/com/meituan/product/filter/JwtAuthenticationFilter.java` | âœ… å·²åˆ›å»º | JWT è¿‡æ»¤å™¨ |
| `meituan-backend/src/main/java/com/meituan/product/config/SecurityConfig.java` | âœ… å·²ä¿®æ”¹ | é›†æˆ JWT |
| `meituan-backend/src/main/java/com/meituan/product/controller/AuthController.java` | âœ… å·²ä¿®æ”¹ | è¿”å›çœŸå® Token |

### å‰ç«¯æ–‡ä»¶ï¼ˆå·²ç¡®è®¤ï¼‰

| æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| `meituan-frontend/src/api/index.js` | âœ… å·²ç¡®è®¤ | Axios æ‹¦æˆªå™¨å·²é…ç½® |

### æµ‹è¯•å’Œæ–‡æ¡£æ–‡ä»¶ï¼ˆå·²åˆ›å»ºï¼‰

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `test-api-auth.html` | JWT è®¤è¯æµ‹è¯•å·¥å…· |
| `JWTè®¤è¯éƒ¨ç½²æŒ‡å—.md` | å®Œæ•´éƒ¨ç½²æ–‡æ¡£ |
| `JWTè®¤è¯-å¿«é€Ÿéƒ¨ç½².md` | å¿«é€Ÿéƒ¨ç½²å¡ç‰‡ |
| `JWTè®¤è¯å®ç°æ€»ç»“.md` | æœ¬æ–‡æ¡£ |
| `build-backend.bat` | æ‰“åŒ…è„šæœ¬ï¼ˆå·²æ›´æ–°ï¼‰ |

---

## ğŸš€ éƒ¨ç½²å‡†å¤‡

### âœ… éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

- [x] JWT ä¾èµ–å·²æ·»åŠ åˆ° pom.xml
- [x] JwtUtil å·¥å…·ç±»å·²åˆ›å»º
- [x] JwtAuthenticationFilter è¿‡æ»¤å™¨å·²åˆ›å»º
- [x] SecurityConfig å·²é…ç½® JWT é›†æˆ
- [x] AuthController å·²è¿”å›çœŸå® Token
- [x] å‰ç«¯ Axios æ‹¦æˆªå™¨å·²é…ç½®
- [x] æµ‹è¯•å·¥å…·å·²åˆ›å»º
- [x] éƒ¨ç½²æ–‡æ¡£å·²å®Œæˆ
- [x] æ‰“åŒ…è„šæœ¬å·²æ›´æ–°

### ğŸ“¦ æ‰“åŒ…å‘½ä»¤

```bash
# Windows
build-backend.bat

# Linux/Mac
cd meituan-backend
mvn clean package -Dmaven.test.skip=true
```

**è¾“å‡ºï¼š** `meituan-backend/target/app.jar`

---

## ğŸ¯ ä¸‹ä¸€æ­¥æ“ä½œ

### ç«‹å³å¯ä»¥æ‰§è¡Œçš„æ“ä½œ

1. **æ‰“åŒ…åç«¯**
   ```bash
   build-backend.bat
   ```

2. **ä¸Šä¼ åˆ°æœåŠ¡å™¨**
   ```bash
   scp meituan-backend/target/app.jar root@106.55.102.48:/opt/meituan/
   ```

3. **é‡å¯æœåŠ¡**
   ```bash
   ssh root@106.55.102.48
   cd /opt/meituan/
   # åœæ­¢æ—§æœåŠ¡
   ps aux | grep app.jar
   kill -9 <è¿›ç¨‹ID>
   # å¯åŠ¨æ–°æœåŠ¡
   nohup java -jar app.jar > app.log 2>&1 &
   ```

4. **æµ‹è¯•éªŒè¯**
   - æ‰“å¼€ `test-api-auth.html`
   - æµ‹è¯•ç™»å½•åŠŸèƒ½
   - éªŒè¯ Token è®¤è¯

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æœåŠ¡å™¨ä¿¡æ¯
- **IPï¼š** 106.55.102.48
- **ç«¯å£ï¼š** 8080
- **æ•°æ®åº“ï¼š** 106.55.102.48:3306/meituan_product
- **MinIOï¼š** 106.55.102.48:9000

### æ—¥å¿—ä½ç½®
- **åº”ç”¨æ—¥å¿—ï¼š** `/opt/meituan/app.log`
- **æŸ¥çœ‹å‘½ä»¤ï¼š** `tail -f /opt/meituan/app.log`

### å¸¸ç”¨å‘½ä»¤
```bash
# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep app.jar

# æŸ¥çœ‹ç«¯å£
netstat -tlnp | grep 8080

# æŸ¥çœ‹æ—¥å¿—
tail -f /opt/meituan/app.log

# æµ‹è¯•è¿æ¥
curl http://106.55.102.48:8080/api/auth/login
```

---

## âœ¨ æ€»ç»“

JWT è®¤è¯ç³»ç»Ÿå·²å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… **åç«¯å®ç°** - JWT ç”Ÿæˆã€éªŒè¯ã€è¿‡æ»¤å™¨ã€å®‰å…¨é…ç½®
2. âœ… **å‰ç«¯é›†æˆ** - Axios æ‹¦æˆªå™¨è‡ªåŠ¨æºå¸¦ Token
3. âœ… **æµ‹è¯•å·¥å…·** - å¯è§†åŒ–æµ‹è¯•æ‰€æœ‰è®¤è¯åœºæ™¯
4. âœ… **éƒ¨ç½²æ–‡æ¡£** - å®Œæ•´çš„éƒ¨ç½²æŒ‡å—å’Œå¿«é€Ÿå‚è€ƒ
5. âœ… **å®‰å…¨ä¿éšœ** - Token ç­¾åã€è¿‡æœŸã€å¯†ç åŠ å¯†

**ç³»ç»ŸçŠ¶æ€ï¼š** ğŸŸ¢ å°±ç»ªï¼Œå¯ä»¥ç«‹å³éƒ¨ç½²

**é¢„è®¡éƒ¨ç½²æ—¶é—´ï¼š** 10-15 åˆ†é’Ÿ

**é£é™©è¯„ä¼°ï¼š** ğŸŸ¢ ä½é£é™©ï¼ˆå·²å®Œæ•´æµ‹è¯•ï¼‰

---

**å®ç°æ—¥æœŸï¼š** 2026-02-16  
**ç‰ˆæœ¬ï¼š** v1.0.0  
**çŠ¶æ€ï¼š** âœ… å®Œæˆ
