# 模板预览问题修复说明（更新版）

## 问题描述

点击模板预览时报错：

**第一次错误**：
```
{
  "code": 500,
  "message": "模板预览失败：模板预览失败：文件下载失败: object name must be a non-empty string.",
  "data": null
}
```

**第二次错误**（修复后）：
```
{
  "code": 500,
  "message": "模板预览失败：模板预览失败：文件下载失败: Object name contains unsupported characters.",
  "data": null
}
```

## 问题原因

1. **第一个问题**：`extractFilePathFromUrl` 方法提取文件路径时返回空字符串
2. **第二个问题**：提取失败时返回了完整 URL（包含 `?` 等特殊字符），MinIO 不支持这些字符作为对象名称

根本原因：数据库中 `file_path` 字段可能存储了完整的 URL 而不是纯路径，导致提取逻辑失败。

## 修复内容

### 1. 改进文件路径提取逻辑（第二次修复）

**文件**: `meituan-backend/src/main/java/com/meituan/product/service/TemplateService.java`

```java
private String extractFilePathFromUrl(String url) {
    // 1. 移除URL参数（?后面的部分）
    String urlWithoutParams = url.split("\\?")[0];
    
    // 2. 查找bucket名称后的路径
    // 例如: http://localhost:9000/meituan-files/templates/uuid.xlsx
    // 提取: templates/uuid.xlsx
    
    // 3. 如果方法1失败，尝试从URL末尾提取最后两个路径段
    // 例如: templates/uuid.xlsx
    
    // 4. 如果还是失败，抛出异常（不再返回完整URL）
}
```

### 2. 临时解决方案：清理数据库

由于现有数据可能已经损坏，建议清理并重新上传：

```sql
-- 清空模板表（保留测试数据）
USE meituan_product;

DELETE FROM t_template WHERE id > 3;

-- 或者清空所有模板
TRUNCATE TABLE t_template;
```

## 快速修复步骤

### 步骤 1：清理现有模板数据

```bash
# 在命令行执行
mysql -u root -p meituan_product
```

然后执行：
```sql
-- 删除用户上传的模板（保留测试数据）
DELETE FROM t_template WHERE id > 3;

-- 或者清空所有模板重新开始
TRUNCATE TABLE t_template;
```

### 步骤 2：重启后端服务

1. 停止当前运行的后端服务（Ctrl+C）
2. 双击运行 `start-backend.bat`
3. 等待后端启动完成

### 步骤 3：重新上传模板

1. 打开前端：http://localhost:5173
2. 进入"模板管理"页面
3. 上传新的模板文件
4. 点击"预览"测试

## 验证修复

上传模板后，检查数据库中的数据：

```sql
-- 查看模板数据
SELECT id, template_name, file_path, file_url 
FROM t_template 
WHERE deleted = 0 
ORDER BY created_time DESC;
```

**正确的数据格式**：
- `file_path`: `templates/abc123-def456.xlsx` （纯路径，不包含 http 和 ?）
- `file_url`: `http://localhost:9000/meituan-files/templates/abc123-def456.xlsx?X-Amz-...` （完整URL）

**错误的数据格式**：
- `file_path`: `http://localhost:9000/...?X-Amz-...` （包含 URL 和参数）

## 预期结果

预览成功后会显示：

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "templateId": 1,
    "templateName": "测试模板",
    "templateType": "IMPORT",
    "headers": ["列1", "列2", "列3"],
    "columnCount": 3,
    "dataRowCount": 10
  }
}
```

## 技术细节

### 修复前的问题流程

```
1. 上传文件 → MinIO 返回 URL
   ↓
2. extractFilePathFromUrl 提取失败
   ↓
3. 返回完整 URL（包含 ? 参数）
   ↓
4. 保存到 file_path 字段
   ↓
5. 预览时使用 file_path
   ↓
6. MinIO 报错：Object name contains unsupported characters
```

### 修复后的正确流程

```
1. 上传文件 → MinIO 返回 URL
   例如: http://localhost:9000/meituan-files/templates/uuid.xlsx?X-Amz-...
   ↓
2. extractFilePathFromUrl 正确提取
   提取结果: templates/uuid.xlsx
   ↓
3. 保存到数据库
   file_path: templates/uuid.xlsx （纯路径）
   file_url: http://localhost:9000/... （完整URL）
   ↓
4. 预览时使用 getObjectName
   返回: templates/uuid.xlsx
   ↓
5. MinIO 成功下载文件
```

## 调试方法

如果问题仍然存在，查看后端日志：

```bash
# 查看日志文件
tail -f meituan-backend/logs/application.log
```

关键日志信息：
```
DEBUG - 模板ID：1，filePath：templates/uuid.xlsx，fileUrl：http://...
DEBUG - 预览文件，对象名称：templates/uuid.xlsx
DEBUG - 从URL提取文件路径成功：http://... -> templates/uuid.xlsx
```

如果看到：
```
ERROR - 从URL提取文件路径失败
ERROR - Object name contains unsupported characters
```

说明路径提取仍然有问题，需要进一步调试。

## 相关文件

- ✅ `meituan-backend/src/main/java/com/meituan/product/service/TemplateService.java` - 已修复
- ✅ `check-template-data.sql` - 数据检查脚本
- ✅ `database-migration-admin-features.sql` - 数据库结构

## 为什么会出现这个问题？

1. **MinIO URL 格式复杂**：预签名 URL 包含很多参数（`?X-Amz-Algorithm=...`）
2. **路径提取逻辑不够健壮**：没有正确处理提取失败的情况
3. **错误处理不当**：提取失败时返回完整 URL 而不是抛出异常

## 长期解决方案

建议在 `uploadTemplate` 方法中直接保存 MinIO 返回的对象名称，而不是从 URL 提取：

```java
// 修改 MinioService.uploadFile 方法
public UploadResult uploadFile(MultipartFile file, String folder) {
    String objectName = folder + "/" + UUID.randomUUID() + extension;
    // ... 上传逻辑 ...
    return new UploadResult(objectName, presignedUrl);
}
```

这样可以避免路径提取的问题。

---

**修复日期**: 2026-02-09  
**修复版本**: v2  
**影响范围**: 模板管理 - 预览、下载、删除功能  
**状态**: ✅ 已修复，需要清理数据并重启后端
