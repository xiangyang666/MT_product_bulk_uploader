# 模板预览问题 - 完整修复方案

## 当前问题

错误信息：`模板不存在`（模板ID：4）

这说明：
1. 前端显示的模板列表中有 ID=4 的模板
2. 但数据库中这条记录已被逻辑删除（`deleted=1`）或物理删除
3. MyBatis-Plus 的 `@TableLogic` 自动过滤了已删除的记录

## 解决方案

### 方案 1：清理前端缓存并刷新（最简单）

1. **刷新前端页面**
   - 按 `Ctrl + F5` 强制刷新浏览器
   - 或者清除浏览器缓存后刷新

2. **重新加载模板列表**
   - 进入"模板管理"页面
   - 模板列表应该会自动刷新
   - 只显示未删除的模板

### 方案 2：清理数据库中的脏数据

如果刷新后问题仍然存在，执行以下 SQL：

```sql
USE meituan_product;

-- 1. 查看所有模板（包括已删除的）
SELECT id, template_name, deleted, created_time
FROM t_template
ORDER BY id;

-- 2. 物理删除已逻辑删除的记录
DELETE FROM t_template WHERE deleted = 1;

-- 3. 重置自增ID（可选）
-- 如果想让ID从1重新开始
-- ALTER TABLE t_template AUTO_INCREMENT = 1;

-- 4. 验证清理结果
SELECT id, template_name, file_path, created_time
FROM t_template
WHERE deleted = 0
ORDER BY id;
```

### 方案 3：完全重置模板表

如果想完全重新开始：

```sql
USE meituan_product;

-- 清空模板表
TRUNCATE TABLE t_template;

-- 插入测试数据（可选）
INSERT INTO t_template (merchant_id, template_name, template_type, file_path, file_size) VALUES
(1, '标准商品导入模板', 'IMPORT', 'templates/standard_import_template.xlsx', 15360),
(1, '美团商品上传模板', 'MEITUAN', 'templates/meituan_upload_template.xlsx', 18432),
(1, '商品导出模板', 'EXPORT', 'templates/product_export_template.xlsx', 12288);

-- 验证
SELECT * FROM t_template;
```

## 操作步骤

### 步骤 1：检查数据库状态

在 MySQL 中执行：

```bash
mysql -u root -p meituan_product
```

```sql
-- 查看所有模板
SELECT id, template_name, deleted FROM t_template ORDER BY id;
```

### 步骤 2：根据情况选择方案

**如果看到 ID=4 的记录且 deleted=1**：
- 执行方案 2（删除逻辑删除的记录）

**如果没有看到 ID=4 的记录**：
- 执行方案 1（刷新前端）

**如果想完全重新开始**：
- 执行方案 3（重置表）

### 步骤 3：刷新前端

1. 在浏览器中按 `Ctrl + F5` 强制刷新
2. 重新进入"模板管理"页面
3. 模板列表应该只显示存在的模板

### 步骤 4：重新上传模板

1. 点击"上传模板"
2. 选择 Excel 文件
3. 填写模板名称和类型
4. 上传成功后，点击"预览"测试

## 为什么会出现这个问题？

1. **逻辑删除机制**：
   - Template 实体使用了 `@TableLogic` 注解
   - 删除操作只是将 `deleted` 字段设为 1
   - MyBatis-Plus 自动过滤 `deleted=1` 的记录

2. **前端缓存**：
   - 前端可能缓存了旧的模板列表
   - 包含已删除的模板 ID

3. **数据不一致**：
   - 前端显示的列表和数据库实际数据不同步

## 预防措施

### 1. 前端自动刷新

建议在删除模板后自动刷新列表：

```javascript
// Template.vue
async handleDelete(id) {
  await api.deleteTemplate(id);
  // 自动刷新列表
  await this.loadTemplates();
}
```

### 2. 后端返回实际数据

确保后端只返回未删除的记录：

```java
// TemplateService.java
public List<Template> getTemplatesByMerchantId(Long merchantId) {
    LambdaQueryWrapper<Template> queryWrapper = new LambdaQueryWrapper<>();
    queryWrapper.eq(Template::getMerchantId, merchantId)
               .eq(Template::getDeleted, 0)  // 显式过滤
               .orderByDesc(Template::getCreatedTime);
    return templateMapper.selectList(queryWrapper);
}
```

## 快速命令

### 查看模板状态
```bash
mysql -u root -p -e "USE meituan_product; SELECT id, template_name, deleted FROM t_template;"
```

### 清理已删除的记录
```bash
mysql -u root -p -e "USE meituan_product; DELETE FROM t_template WHERE deleted = 1;"
```

### 重置模板表
```bash
mysql -u root -p -e "USE meituan_product; TRUNCATE TABLE t_template;"
```

## 验证修复

修复后，执行以下检查：

1. ✅ 数据库中只有未删除的模板（`deleted=0`）
2. ✅ 前端模板列表与数据库一致
3. ✅ 点击预览能正常显示模板结构
4. ✅ 上传新模板后能立即预览

## 总结

这个问题的根本原因是**前端缓存的模板列表包含了已删除的记录**。

**最简单的解决方法**：
1. 刷新浏览器（Ctrl + F5）
2. 如果还不行，清理数据库中的逻辑删除记录

**长期解决方案**：
1. 删除后自动刷新前端列表
2. 后端显式过滤已删除记录
3. 定期清理逻辑删除的数据

---

**更新日期**: 2026-02-09  
**问题**: 模板不存在（ID=4）  
**状态**: ✅ 解决方案已提供
