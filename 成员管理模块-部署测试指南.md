# 成员管理模块 - 部署测试指南

## 当前状态

✅ 后端开发完成
✅ 前端开发完成  
✅ 数据库迁移脚本已修复
✅ 密码加密已实现（BCrypt）
✅ 登录验证已更新

## 部署步骤

### 1. 数据库迁移

执行数据库迁移脚本：

```bash
mysql -u root -p meituan_product < database-migration-member-management.sql
```

这个脚本会：
- 扩展 `user` 表，添加 `created_by` 和 `updated_by` 字段
- 扩展 `operation_log` 表，添加 `target_username` 字段
- 创建索引
- 创建默认管理员账号（admin/123456）
- 创建统计视图

### 2. 启动后端服务

```bash
cd meituan-backend
mvn clean install
mvn spring-boot:run
```

或使用启动脚本：
```bash
start-backend.bat
```

### 3. 启动前端服务

```bash
cd meituan-frontend
npm install
npm run dev
```

或使用启动脚本：
```bash
start-frontend.bat
```

## 测试步骤

### 1. 登录测试

访问前端登录页面，使用以下账号登录：

- **用户名**: `admin`
- **密码**: `123456`
- **角色**: 超级管理员

预期结果：登录成功，跳转到主页面

### 2. 成员管理功能测试

#### 2.1 查看成员列表
1. 点击左侧菜单 "成员管理"
2. 查看成员列表
3. 测试筛选功能（用户名、角色、状态）
4. 测试分页功能

#### 2.2 创建成员
1. 点击 "添加成员" 按钮
2. 填写表单：
   - 用户名：test_user
   - 密码：Test@123456
   - 真实姓名：测试用户
   - 邮箱：test@example.com
   - 角色：普通用户
3. 点击确定
4. 验证成员创建成功

#### 2.3 编辑成员
1. 点击某个成员的 "编辑" 按钮
2. 修改信息（如真实姓名、邮箱）
3. 点击确定
4. 验证修改成功

#### 2.4 修改密码
1. 点击某个成员的 "修改密码" 按钮
2. 输入新密码
3. 点击确定
4. 使用新密码登录验证

#### 2.5 修改状态
1. 点击某个成员的 "禁用" 按钮
2. 确认禁用
3. 验证状态变更为禁用
4. 尝试使用该账号登录（应该失败）
5. 点击 "启用" 按钮恢复

#### 2.6 删除成员
1. 点击某个成员的 "删除" 按钮
2. 确认删除
3. 验证成员已从列表中移除

### 3. 个人设置功能测试

#### 3.1 查看个人信息
1. 点击右上角用户头像
2. 选择 "个人设置"
3. 查看当前用户信息

#### 3.2 修改个人信息
1. 修改真实姓名、邮箱、手机号
2. 点击保存
3. 验证修改成功

#### 3.3 修改密码
1. 切换到 "修改密码" 标签
2. 输入旧密码和新密码
3. 点击保存
4. 退出登录
5. 使用新密码重新登录验证

### 4. 权限测试

#### 4.1 超级管理员权限
- ✅ 可以查看所有成员
- ✅ 可以创建任何角色的成员
- ✅ 可以编辑任何成员
- ✅ 可以修改任何成员的密码
- ✅ 可以禁用/启用任何成员
- ✅ 可以删除任何成员（除了自己）

#### 4.2 管理员权限
- ✅ 可以查看所有成员
- ✅ 可以创建普通用户
- ✅ 可以编辑普通用户
- ✅ 可以修改普通用户的密码
- ✅ 可以禁用/启用普通用户
- ✅ 可以删除普通用户
- ❌ 不能操作超级管理员和其他管理员

#### 4.3 普通用户权限
- ✅ 可以查看自己的信息
- ✅ 可以修改自己的信息
- ✅ 可以修改自己的密码
- ❌ 不能访问成员管理页面
- ❌ 不能操作其他用户

### 5. 操作日志测试

查询数据库验证操作日志：

```sql
SELECT * FROM operation_log 
WHERE operation_type LIKE 'MEMBER_%' 
ORDER BY created_at DESC 
LIMIT 10;
```

应该记录以下操作：
- MEMBER_CREATE - 创建成员
- MEMBER_UPDATE - 更新成员
- MEMBER_DELETE - 删除成员
- MEMBER_PASSWORD_CHANGE - 修改密码
- MEMBER_STATUS_CHANGE - 修改状态

## 常见问题

### Q1: 登录失败，提示"密码错误"

**原因**: 数据库中的密码可能不是正确的 BCrypt 格式

**解决方案**: 执行密码更新脚本
```bash
mysql -u root -p meituan_product < update-admin-password.sql
```

### Q2: 后端启动失败，提示找不到 BCryptPasswordEncoder

**原因**: 缺少 Spring Security 依赖

**解决方案**: 检查 `pom.xml` 是否包含：
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

### Q3: 前端访问成员管理页面显示空白

**原因**: 路由配置问题或权限不足

**解决方案**: 
1. 检查路由配置 `src/router/index.js`
2. 确认当前用户有访问权限
3. 检查浏览器控制台错误信息

### Q4: 创建成员时提示"权限不足"

**原因**: 当前用户角色权限不够

**解决方案**: 
1. 使用超级管理员账号登录
2. 检查后端 `PermissionService` 权限逻辑

## API 端点

### 成员管理
- `GET /api/members` - 获取成员列表
- `POST /api/members` - 创建成员
- `PUT /api/members/{id}` - 更新成员
- `DELETE /api/members/{id}` - 删除成员
- `PUT /api/members/{id}/password` - 修改成员密码
- `PUT /api/members/{id}/status` - 修改成员状态

### 个人设置
- `GET /api/profile` - 获取个人信息
- `PUT /api/profile` - 更新个人信息
- `PUT /api/profile/password` - 修改个人密码

## 数据库表结构

### user 表
```sql
CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码（BCrypt加密）',
  `real_name` varchar(50) DEFAULT NULL COMMENT '真实姓名',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `merchant_id` bigint DEFAULT NULL COMMENT '商家ID',
  `role` varchar(20) NOT NULL DEFAULT 'USER' COMMENT '角色',
  `status` int NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
  `last_login_at` datetime DEFAULT NULL COMMENT '最后登录时间',
  `created_at` datetime DEFAULT NULL COMMENT '创建时间',
  `updated_at` datetime DEFAULT NULL COMMENT '更新时间',
  `created_by` varchar(50) DEFAULT NULL COMMENT '创建者',
  `updated_by` varchar(50) DEFAULT NULL COMMENT '更新者',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_role` (`role`)
);
```

## 下一步

1. ✅ 执行数据库迁移
2. ✅ 启动后端服务
3. ✅ 启动前端服务
4. ✅ 使用 admin/123456 登录测试
5. ✅ 测试所有功能
6. ⏭️ 根据测试结果调整和优化

## 联系支持

如有问题，请查看：
- `管理员密码修复说明.md` - 密码问题解决方案
- `MEMBER_MANAGEMENT_COMPLETE.md` - 完整实现文档
- `MEMBER_MANAGEMENT_SUMMARY.md` - 功能总结
